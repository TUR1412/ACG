# 变更提案: evolution_v0_10_fulltext_worker

## 需求背景
上一轮（v0.9）已经将全文预览的“重型后处理”延后到 idle，并在低性能/滚动期对自动翻译做了保守降级，明显降低了移动端卡顿的概率。

但全文预览仍然存在一个“结构性瓶颈”：
- **Markdown → HTML 渲染与翻译切块处理仍在主线程执行**：当正文较长时，即使减少了 DOM 后处理，主线程仍可能出现短时间的计算阻塞，导致“滑动/点击卡一下”的体感。

因此需要进一步升级为 **Worker 化的全文预览流水线**：把 CPU 密集的字符串处理（渲染/翻译拼接等）迁移到 Web Worker，让主线程优先保证滚动与交互稳定。

## 产品分析

### 目标用户与场景
- **用户群体:** 移动端碎片化阅读为主的用户；弱设备/低性能机型用户。
- **使用场景:** 打开详情页后快速滚动浏览；在全文预览区域查看原文或翻译。
- **核心痛点:** 正文较长时主线程被阻塞，导致“滚动/切换卡一下”；翻译过程中页面变得不跟手。

### 价值主张与成功指标
- **价值主张:** 保持“静态站 + 本地优先”的低运维结构不变，把全文预览的重计算从主线程移走，让移动端体验更接近原生资讯 App。
- **成功指标:**
  - 全文预览渲染与翻译过程中，主线程更少出现可感知的卡顿（尤其是滚动与按钮点击）。
  - 在 Worker 不可用或初始化失败时可无缝回退到主线程实现（可用性优先）。
  - 保持现有的降级策略：低性能/滚动期默认不自动翻译，用户仍可手动触发。

### 人文关怀
继续坚持本地优先：不上传任何阅读内容或用户行为；全文预览仍为实验能力，失败时始终提供“打开原文”的可靠路径。

## 变更内容
1. 新增全文预览 Worker：承担 Markdown 渲染（Markdown→HTML）与翻译（gtx）等重计算。
2. 客户端全文预览改造为“请求-响应”流水线：主线程只负责 UI 状态、DOM 注入与轻量后处理调度。
3. 增强兼容性：Worker 失败自动回退到主线程渲染/翻译。
4. 进一步保守策略：低性能模式下默认不自动加载/翻译（保留按钮手动入口）。

## 影响范围
- **模块:** client-app
- **文件:**
  - `src/client/features/fulltext.ts`
  - `src/client/workers/fulltext.worker.ts`（新增）
  - `src/client/utils/cover.ts`
  - `helloagents/wiki/modules/client-app.md`
  - `helloagents/wiki/arch.md`
  - `helloagents/CHANGELOG.md`

## 核心场景

### 需求: 全文预览更顺滑（Worker 化）
**模块:** client-app

#### 场景: 移动端渲染长文
正文较长时，渲染与翻译不应阻塞滚动与交互。
- 预期结果: 渲染/翻译的 CPU 密集步骤在 Worker 执行，主线程更稳定。

#### 场景: 兼容性与回退
部分环境可能无法创建 Worker 或模块 Worker。
- 预期结果: 自动回退到主线程实现，功能仍可用。

## 风险评估
- **风险:** Worker 初始化失败（旧浏览器/策略限制）或增加少量实现复杂度。
- **缓解:** 设计为“可选加速层”，失败则回退主线程；同时使用 requestId/令牌避免错序更新。

