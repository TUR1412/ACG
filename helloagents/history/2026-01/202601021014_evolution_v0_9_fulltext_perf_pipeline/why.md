# 变更提案: evolution_v0_9_fulltext_perf_pipeline

## 需求背景
ACG Radar 作为“伪全栈”的静态资讯站，核心体验集中在：**快速浏览**（列表/分类/搜索）与 **深度阅读**（详情页/全文预览-实验）。

当前主要痛点集中在“全文预览（实验）”：
1. **噪音与不稳定**：阅读模式/抽取结果偶发混入导航、推荐、免责声明、纯链接列表等内容，导致“正文被污染”。
2. **移动端卡顿**：详情页中全文预览进入视口后会触发较重的渲染/清洗/增强逻辑，叠加自动翻译的网络与切块处理，容易在移动端出现“卡一下”的体感。

同时，随着来源扩展与抓取数量提升，抓取管线也需要进一步升级：
- **可扩量的来源适配**：避免在同步脚本中出现“按 source.id 特判”的维护负担。
- **更好的数据质量**：规范化 URL（尤其是去除常见追踪参数）以减少重复与脏数据。
- **更稳的抓取稳定性**：对瞬时失败（超时/5xx/429）做保守重试与退避，降低误报与波动。

## 产品分析

### 目标用户与场景
- **用户群体:** 资讯流重度用户（移动端为主，碎片化阅读）+ PC 端轻度用户（快速扫一眼）。
- **使用场景:** 通勤/排队/午休等短时段浏览；看到感兴趣条目后进入详情页深度阅读。
- **核心痛点:** 移动端进入详情页时体感卡顿；全文预览偶尔“满屏杂链/图墙/免责声明”影响阅读。

### 价值主张与成功指标
- **价值主张:** 在保持“静态站 + Actions 定时同步”的低运维优势前提下，把全文预览体验打磨到“可用且顺滑”，并让抓取系统更易扩量、更稳、更可观测。
- **成功指标:**
  - 移动端打开详情页与滚动到全文预览区域时不出现明显的主线程阻塞卡顿（以“体感顺滑”为第一目标）。
  - 全文预览在低性能模式下默认不自动触发高开销后处理/自动翻译（但保留手动入口）。
  - 同步脚本不再依赖硬编码 source.id 特判；新增 HTML 来源只需新增适配器并注册。
  - URL 规范化减少追踪参数导致的重复条目，提升去重质量。

### 人文关怀
默认不上传任何用户行为数据；全文预览为实验能力，明确提示版权归原站，并提供失败时“打开原文”的稳定退路。

## 变更内容
1. 全文预览：引入“性能感知”的渲染与后处理策略（低性能/滚动期更保守），减少移动端卡顿。
2. 全文预览：将重型 DOM 后处理（去壳/增强）延后到 idle 执行，并对低性能设备做降级。
3. 同步管线：HTML 来源解析改为注册表/插件式，移除同步脚本中的硬编码特判。
4. 同步管线：增强 URL 规范化（去除常见追踪参数），提升去重与数据质量。
5. 同步管线：对瞬时网络失败增加保守重试 + jitter 退避（可控、不过度轰炸）。

## 影响范围
- **模块:** client-app / pipeline-sync / shared-lib
- **文件:**
  - `src/client/features/fulltext.ts`
  - `scripts/sync.ts`
  - `scripts/sources/*`
  - `scripts/lib/http-cache.ts`
  - `helloagents/wiki/modules/*`
  - `helloagents/CHANGELOG.md`

## 核心场景

### 需求: 全文预览更顺滑
**模块:** client-app

#### 场景: 移动端打开详情页
进入详情页后，页面可以先展示标题/摘要/封面等核心信息；全文预览在进入视口时加载，但不应造成明显卡顿。
- 预期结果: 低性能模式下不自动触发高开销后处理与自动翻译；用户手动触发仍可用。

#### 场景: 滚动中不抢主线程
用户滚动时应优先保证滚动流畅度。
- 预期结果: 滚动期不自动启动翻译等重任务；必要时延后到滚动停止再执行。

### 需求: 抓取更稳且可扩量
**模块:** pipeline-sync

#### 场景: 新增 HTML 来源
新增来源时不应修改同步主流程逻辑，只需新增适配器并注册。
- 预期结果: 同步脚本通过“来源解析注册表”自动路由到对应解析器。

### 需求: 数据质量更好
**模块:** pipeline-sync / shared-lib

#### 场景: 追踪参数导致重复
同一新闻因 `utm_*`、`fbclid` 等参数产生多条重复项。
- 预期结果: URL 规范化剥离常见追踪参数，去重更准确。

## 风险评估
- **风险:** 全文预览依赖第三方阅读模式/跨站抓取，可能被限流或返回拦截体；翻译依赖公共 gtx 端点，偶发不稳定。
- **缓解:** 默认策略更保守（低性能与滚动期不自动做重活）；失败直接提示并引导“打开原文”；同步侧重试为“少量+退避”，避免放大站点压力。

