# 技术设计: evolution_v0_9_fulltext_perf_pipeline

## 技术方案

### 核心技术
- Astro（静态站点输出）+ TypeScript
- GitHub Actions 定时同步 → 构建 → Pages 部署
- 客户端增强：lazy chunk（全文预览、命令面板等）
- 同步脚本：Node.js `fetch` + 本地 `.cache`（HTTP/翻译缓存）

### 实现要点

#### 1) 全文预览（客户端）性能策略升级
目标：减少“进入详情页/滚动到全文预览区域时卡一下”的体感，且不牺牲可用性。

- **性能感知（perf-aware）**：
  - 识别 `data-acg-perf="low"`（自动低性能模式）与 `data-acg-scroll="1"`（滚动期）。
  - 低性能/滚动期：默认不自动触发“重型后处理/自动翻译”，把主线程优先让给滚动与交互。
- **后处理延后（idle post-process）**：
  - 首次渲染：先把 Markdown → HTML 渲染结果插入 DOM（让用户尽快看到内容）。
  - 结构去壳、图墙治理、链接卡片化等增强逻辑：延后到 idle 执行，并在低性能模式下做阈值限制。

#### 2) 同步管线（scripts）可扩量与稳定性升级
目标：新增来源更“插件化”，并减少瞬时失败造成的波动。

- **HTML 来源解析注册表**：
  - 将 HTML 解析器按 `source.id` 注册到统一入口，避免在 `scripts/sync.ts` 写特判。
  - 同步主流程只负责：拉取 → 解析（按 kind 路由）→ 清洗 → 生成产物。
- **URL 规范化增强（数据质量）**：
  - 在 `normalizeUrl` 中剥离常见追踪参数（如 `utm_*` / `fbclid` / `gclid` 等），降低重复条目。
- **保守重试 + jitter（抓取稳定性）**：
  - 对超时、429、5xx 等瞬时失败做少量重试，并加入抖动避免拥塞。
  - 保持“来源失败不影响全站”的原则：失败时回退缓存/历史数据，status.json 记录 used=fallback。

## 架构决策 ADR

### ADR-006: 全文预览采用“渲染快速可见 + idle 后处理”的分阶段策略
**上下文:** 全文预览渲染与去壳/增强逻辑在移动端可能造成主线程阻塞，影响滚动与交互体验。
**决策:** 首次渲染优先把内容呈现出来，DOM 后处理延后到 idle；低性能/滚动期默认不自动做重活（自动翻译、重型增强等）。
**理由:** 以用户体感为先（滚动/点击优先），并保持“手动触发仍可用”的可控性。
**替代方案:** 把全部渲染/后处理改为 Web Worker → 需要较大重构与跨 DOM 传输；本次先采取低风险分阶段策略。
**影响:** 代码复杂度小幅增加，但显著降低移动端卡顿风险；后处理延后可能导致短时间内“增强效果稍后才出现”。

### ADR-007: 同步管线的 HTML 来源解析采用注册表（插件式）
**上下文:** `scripts/sync.ts` 中按 `source.id` 特判会随着来源增多而不可维护。
**决策:** 将 HTML 解析器集中注册并提供统一解析入口，同步主流程不再包含特判。
**理由:** 新增来源只改适配器文件与注册表，减少主流程耦合。
**替代方案:** 继续写 if/else 特判 → 维护成本随来源数量线性上升。
**影响:** 同步侧结构更清晰，利于扩量与回归测试。

### ADR-008: URL 规范化剥离常见追踪参数
**上下文:** 多来源/同来源的不同入口可能在 URL 上带追踪参数，导致重复条目与去重失败。
**决策:** 在同步阶段对 URL 做规范化，去除常见追踪参数，仅保留影响内容定位的关键参数。
**理由:** 提升数据质量与去重效果，降低噪声。
**替代方案:** 仅按标题相似度去重 → 复杂且存在误伤风险。
**影响:** 少数站点若把追踪参数用于内容分流可能产生影响；采用“保守白名单”策略降低风险。

### ADR-009: 抓取请求增加保守重试与 jitter 退避
**上下文:** 网络抖动/站点限流/瞬时 5xx 会造成单次同步失败，从而影响数据完整性与状态页可用性。
**决策:** 对可重试失败做少量重试并加入随机抖动（jitter），避免同步同时刻放大拥塞。
**理由:** 提升稳定性，同时保持对源站的友好。
**替代方案:** 无重试 → 误报与波动更明显；多次重试 → 可能加重源站压力。
**影响:** 同步耗时在失败场景下会略增，但总体更稳。

## 安全与性能
- 客户端：默认不上传用户行为数据；全文预览失败/异常时仅提示并引导打开原文。
- 同步侧：重试次数严格受控；并加入 jitter，避免“整点拥塞”。

## 测试与部署
- 类型检查：`npm run check`
- 同步产物校验：`npm run validate`
- 构建与体积预算：`npm run build` + `npm run budget`
- 部署：GitHub Actions `hourly-sync-and-deploy.yml`

