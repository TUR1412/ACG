# 变更提案: 观测增强（错误捕获 + 性能埋点）与 Atomic UI 组件化

## 需求背景

当前项目核心架构稳定：定时同步抓取 → 静态构建 → GitHub Pages 部署；浏览器端则以“本地优先”完成收藏/已读/过滤/搜索等交互闭环。随着能力密度提升，项目在工程侧仍存在一些行业常见“薄弱点”：

- **错误可见性不足：** 一旦发生未捕获异常，用户只感知“卡住/无响应”，而维护者难以回溯。
- **性能数据缺口：** 缺少轻量 Web Vitals / longtask 级别的本地观测，无法在不引入后端的前提下定位“卡顿感”来源。
- **UI 复用颗粒偏粗：** 首页/分类页等信息流的 chips 与按钮存在重复标记，后续视觉与交互升级成本偏高，不利于持续迭代。

本变更遵循开闭原则（OCP）：**在不改变核心架构与既有业务逻辑根基的前提下**，通过增量扩展补齐观测链路与原子级 UI 组件库，让后续迭代更快、更稳、更可维护。

## 产品分析

### 目标用户与场景
- **阅读用户:** 关注“顺滑、可控、少干扰”的信息流体验；需要在异常时获得可理解的反馈。
- **维护者/贡献者:** 需要低成本定位线上问题与性能劣化趋势，并保持改动可回滚。

### 价值主张与成功指标
- **价值主张:** 用“本地优先”的方式补齐错误与性能观测，让体验问题可定位；用 Atomic UI 抽象降低 UI 变更成本。
- **成功指标:**
  - 未捕获异常（error/unhandledrejection）被捕获并记入本地 telemetry，必要时给出轻提示，不影响继续使用。
  - 采集并记录基础性能指标（LCP/CLS/longtask），在不增加关键路径成本的前提下可用于排障。
  - chips 相关 UI 标记实现原子组件化（至少覆盖首页/分类页与信号板），降低重复与未来变更成本。

### 人文关怀
- 尊重隐私：默认不上传，仅在用户显式开启后才上报。
- 低噪音：错误提示做节流与去重，避免“雪崩式 toast”打扰。

## 变更内容
1. 新增全局错误捕获模块：捕获 `error` / `unhandledrejection` 并写入 telemetry，必要时通过 Toast 做轻提示。
2. 新增性能观测模块：基于 `PerformanceObserver` 采集 LCP/CLS/longtask，并记录到 telemetry（本地优先）。
3. 引入 Atomic UI 组件（atoms）：抽象 chips/按钮等基础组件，并在信息流页面增量替换复用。
4. 扩展单元测试覆盖：为新增的“纯函数/归一化逻辑”补齐测试，保持可验证性。
5. 重写/升级双语 README，并同步知识库（SSOT）以反映新增观测能力与组件结构。

## 影响范围
- **模块:** client-app、web-ui、docs
- **文件:** `src/client/app.ts`、`src/client/utils/*`、`src/components/*`、`src/pages/*`、`tests/*`、`README.md`、`helloagents/wiki/*`、`package.json`
- **API:** 无
- **数据:** 仅新增/扩展本地 telemetry 事件类型（不改变既有数据产物）

## 核心场景

### 需求: 未捕获异常可回溯
**模块:** client-app
在用户端发生异常时，不影响基本可用性，并留下可回溯线索。

#### 场景: Promise 未处理拒绝
页面逻辑出现 `unhandledrejection`（例如网络/解析异常）。
- 预期结果: 事件被记录到 telemetry（含去重与截断）；必要时给出轻提示，不打断用户操作。

#### 场景: 运行时脚本异常
页面出现未捕获 `error`。
- 预期结果: 记录并提示；不导致无限循环或大量重复 toast。

### 需求: 性能问题可定位
**模块:** client-app
在不引入后端的前提下获得基础性能线索，用于定位卡顿与布局抖动。

#### 场景: 采集并记录 Web Vitals
进入页面后采集 LCP/CLS，页面隐藏时写入 telemetry。
- 预期结果: telemetry 记录包含指标值与必要的上下文（路径/设备档位等）。

#### 场景: 识别长任务
页面交互产生 longtask。
- 预期结果: longtask 以抽样方式记录（节流/采样），避免 telemetry 膨胀。

### 需求: Atomic UI 降低重复
**模块:** web-ui
chips 与基础按钮具备可复用“原子”组件，方便统一样式与交互语义。

#### 场景: 首页/分类页 chips 统一渲染
首页/分类页 chips 使用原子组件渲染。
- 预期结果: 输出结构一致，视觉一致，后续修改只需改 atom。

## 风险评估
- **风险:** 性能观测使用 `PerformanceObserver`，兼容性与开销需要控制；错误 toast 可能造成干扰。
- **缓解:** 所有观测均 try/catch 包裹；默认采样/节流；对低性能模式与减少动效模式自动降级提示与采集频率。

