---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { readGeneratedStatus, readGeneratedStatusHistory } from "../../lib/generated-data";
import { formatDateTime } from "../../lib/format";
import { t } from "../../i18n/i18n";
import { href } from "../../lib/href";
import { safeExternalHttpUrl } from "../../lib/safe-url";

const status = await readGeneratedStatus();
const history = await readGeneratedStatusHistory();
const updatedAt = status.generatedAt ? formatDateTime("zh", status.generatedAt) : "-";

const totalSources = status.sources.length;
const okSources = status.sources.filter((s) => s.ok).length;
const errSources = totalSources - okSources;
const totalItems = status.sources.reduce((sum, s) => sum + (s.itemCount ?? 0), 0);
const totalNewItems = status.sources.reduce((sum, s) => sum + (s.newItemCount ?? 0), 0);
const flakySources = status.sources.filter(
  (s) => typeof s.consecutiveFails === "number" && s.consecutiveFails >= 3
).length;
const staleThresholdHours = 72;
const slowest = [...status.sources].sort((a, b) => b.durationMs - a.durationMs)[0];
const successRate = totalSources > 0 ? Math.round((okSources / totalSources) * 100) : 0;

const generatedAtMs = status.generatedAt ? Date.parse(status.generatedAt) : NaN;
const historyEntries = Array.isArray(history.entries)
  ? [...history.entries].sort((a, b) => a.generatedAt.localeCompare(b.generatedAt))
  : [];
const historyLast30 = historyEntries.slice(-30);
const showTrend = historyEntries.length >= 2;

function pct(ok: number, total: number): number {
  if (!Number.isFinite(ok) || !Number.isFinite(total) || total <= 0) return 0;
  return Math.max(0, Math.min(100, Math.round((ok / total) * 100)));
}

function sparkPath(values: number[], w = 120, h = 40, pad = 2): string {
  if (!Array.isArray(values) || values.length === 0) return "";
  const min = Math.min(...values);
  const max = Math.max(...values);
  const range = max - min || 1;
  const innerW = Math.max(1, w - pad * 2);
  const innerH = Math.max(1, h - pad * 2);
  const step = values.length > 1 ? innerW / (values.length - 1) : 0;

  let d = "";
  for (let i = 0; i < values.length; i += 1) {
    const v = values[i];
    const x = pad + step * i;
    const y = pad + innerH * (1 - (v - min) / range);
    const p = `${x.toFixed(2)},${y.toFixed(2)}`;
    d += i === 0 ? `M${p}` : ` L${p}`;
  }
  return d;
}

const trendSuccess30 = historyLast30.map((e) => pct(e.okSources, e.totalSources));
const trendErr30 = historyLast30.map((e) => e.errSources);
const trendNew30 = historyLast30.map((e) => e.totalNewItems);
const trendNowSuccess = trendSuccess30.length > 0 ? trendSuccess30[trendSuccess30.length - 1] : successRate;
const trendNowErr = trendErr30.length > 0 ? trendErr30[trendErr30.length - 1] : errSources;
const trendNowNew = trendNew30.length > 0 ? trendNew30[trendNew30.length - 1] : totalNewItems;
const trendUpdatedAt = history.generatedAt ? formatDateTime("zh", history.generatedAt) : updatedAt;
function staleHours(latestPublishedAt?: string): number | null {
  if (!latestPublishedAt) return null;
  if (!Number.isFinite(generatedAtMs)) return null;
  const latestMs = Date.parse(latestPublishedAt);
  if (!Number.isFinite(latestMs)) return null;
  const diffMs = Math.max(0, generatedAtMs - latestMs);
  return diffMs / (1000 * 60 * 60);
}

const staleSources = status.sources.filter((s) => {
  const h = staleHours(s.latestPublishedAt);
  return h != null && h >= staleThresholdHours;
}).length;

function fmt(latestPublishedAt?: string): string {
  if (!latestPublishedAt) return "-";
  try {
    return formatDateTime("zh", latestPublishedAt);
  } catch {
    return latestPublishedAt;
  }
}

function suggest(s: (typeof status.sources)[number]): string {
  const stale = staleHours(s.latestPublishedAt);
  if (s.ok) {
    if (stale != null && stale >= staleThresholdHours)
      return `可能停更/抓取卡住：最新发布时间距今超过 ${staleThresholdHours} 小时。`;
    return "-";
  }
  if (typeof s.consecutiveFails === "number" && s.consecutiveFails >= 3) {
    return `连续失败 ${s.consecutiveFails} 次：建议检查来源 URL/解析器/是否被拦截。`;
  }
  if (s.httpStatus === 429) return "请求过于频繁：可降低更新频率、启用缓存或稍后重试。";
  if (s.httpStatus === 403 || s.httpStatus === 401) return "可能被拦截：建议改用 RSS/公开源，或减少抓取。";
  if (s.httpStatus === 404) return "地址可能变更：检查来源 URL 并更新适配器。";
  const err = (s.error ?? "").toLowerCase();
  if (err.includes("parse_empty") || err.includes("parse_drop"))
    return "解析输出异常：建议检查来源结构变化/反爬拦截，必要时更新解析器或更换来源。";
  if (err.includes("timeout") || err.includes("aborted")) return "请求超时：可稍后重试或降低并发。";
  return "请查看错误详情，并在 sources 配置中调整该来源。";
}
---

<SiteLayout lang="zh" title={t("zh", "status.title")} currentPath="/status/">
  <div class="glass rounded-2xl p-5">
    <h1 class="m-0 text-2xl font-semibold leading-tight tracking-tight text-slate-950 md:text-3xl">
      {t("zh", "status.title")}
    </h1>
    <p class="mt-2 text-sm text-slate-700">
      {t("zh", "status.lastRun")}: {updatedAt} · {status.durationMs}ms
    </p>
    <div class="mt-3 flex flex-wrap gap-2">
      <a
        class="glass inline-flex items-center gap-2 rounded-xl px-3 py-2 text-xs font-medium text-slate-950 clickable"
        href={href("/zh/telemetry/")}
      >
        {t("zh", "telemetry.title")}
      </a>
    </div>
  </div>

  {
    showTrend ? (
      <section class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <div class="glass shine rounded-2xl p-5">
          <div class="flex items-end justify-between gap-4">
            <div>
              <div class="text-xs font-semibold text-slate-600">成功率趋势（近30轮）</div>
              <div class="mt-2 text-2xl font-semibold text-slate-950">{trendNowSuccess}%</div>
              <div class="mt-1 text-xs text-slate-600">更新：{trendUpdatedAt}</div>
            </div>
            <svg class="h-10 w-28 text-emerald-700" viewBox="0 0 120 40" aria-hidden="true">
              <path
                d={sparkPath(trendSuccess30)}
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </div>
        </div>

        <div class="glass shine rounded-2xl p-5">
          <div class="flex items-end justify-between gap-4">
            <div>
              <div class="text-xs font-semibold text-slate-600">异常来源趋势（近30轮）</div>
              <div class="mt-2 text-2xl font-semibold text-rose-800">{trendNowErr}</div>
              <div class="mt-1 text-xs text-slate-600">连续失败≥3：{flakySources}</div>
            </div>
            <svg class="h-10 w-28 text-rose-700" viewBox="0 0 120 40" aria-hidden="true">
              <path
                d={sparkPath(trendErr30)}
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </div>
        </div>

        <div class="glass shine rounded-2xl p-5">
          <div class="flex items-end justify-between gap-4">
            <div>
              <div class="text-xs font-semibold text-slate-600">新增条目趋势（近30轮）</div>
              <div class="mt-2 text-2xl font-semibold text-slate-950">{trendNowNew}</div>
              <div class="mt-1 text-xs text-slate-600">疑似停更：{staleSources}</div>
            </div>
            <svg class="h-10 w-28 text-slate-800" viewBox="0 0 120 40" aria-hidden="true">
              <path
                d={sparkPath(trendNew30)}
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </div>
        </div>
      </section>
    ) : (
      <div class="mt-6 glass rounded-2xl p-5 text-sm text-slate-700">
        趋势数据尚未积累：请等待下一轮同步后再查看（需要至少 2 轮记录）。
      </div>
    )
  }

  <section class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <div class="glass shine rounded-2xl p-5">
      <div class="text-xs font-semibold text-slate-600">成功率</div>
      <div class="mt-2 text-2xl font-semibold text-slate-950">{successRate}%</div>
      <div class="mt-1 text-xs text-slate-600">
        正常 {okSources} / {totalSources}
      </div>
    </div>

    <div class="glass shine rounded-2xl p-5">
      <div class="text-xs font-semibold text-slate-600">异常来源</div>
      <div class="mt-2 text-2xl font-semibold text-rose-800">{errSources}</div>
      <div class="mt-1 text-xs text-slate-600">连续失败≥3：{flakySources} · 单个来源失败不会影响全站部署</div>
    </div>

    <div class="glass shine rounded-2xl p-5">
      <div class="text-xs font-semibold text-slate-600">本次条目</div>
      <div class="mt-2 text-2xl font-semibold text-slate-950">{totalItems}</div>
      <div class="mt-1 text-xs text-slate-600">新增 {totalNewItems} · 疑似停更 {staleSources}</div>
    </div>

    <div class="glass shine rounded-2xl p-5">
      <div class="text-xs font-semibold text-slate-600">最慢来源</div>
      <div class="mt-2 text-base font-semibold text-slate-950 line-clamp-3">{slowest?.name ?? "-"}</div>
      <div class="mt-1 text-xs text-slate-600">
        {slowest ? `${slowest.durationMs}ms · ${slowest.used}` : "-"}
      </div>
    </div>
  </section>

  <div class="mt-6 glass rounded-2xl p-5">
    <h2 class="m-0 text-sm font-semibold text-slate-950">{t("zh", "status.sources")}</h2>
    <div class="mt-3 overflow-x-auto">
      <table class="w-full border-separate border-spacing-y-2 text-sm">
        <thead class="text-left text-xs text-slate-600">
          <tr>
            <th class="px-3">来源</th>
            <th class="px-3">状态</th>
            <th class="px-3">条目</th>
            <th class="px-3">新增</th>
            <th class="px-3">最新</th>
            <th class="px-3">连续</th>
            <th class="px-3">解析</th>
            <th class="px-3">HTTP</th>
            <th class="px-3">耗时</th>
            <th class="px-3">重试</th>
            <th class="px-3">方式</th>
            <th class="px-3">错误</th>
            <th class="px-3">建议</th>
          </tr>
        </thead>
        <tbody>
          {
            status.sources.map((s) => (
              <tr class="glass">
                <td class="px-3 py-2">
                  {(() => {
                    const u = safeExternalHttpUrl(s.url);
                    if (!u) return <span class="font-medium text-slate-950">{s.name}</span>;
                    return (
                      <a
                        class="font-medium text-slate-950 hover:underline"
                        href={u}
                        target="_blank"
                        rel="noreferrer noopener"
                      >
                        {s.name}
                      </a>
                    );
                  })()}
                  <div class="text-xs text-slate-600">{s.id}</div>
                </td>
                <td class="px-3 py-2">
                  <span
                    class:list={[
                      "rounded-full px-3 py-1 text-xs font-medium",
                      s.ok ? "bg-emerald-500/15 text-emerald-800" : "bg-rose-500/15 text-rose-800"
                    ]}
                  >
                    {s.ok ? t("zh", "status.ok") : t("zh", "status.error")}
                  </span>
                </td>
                <td class="px-3 py-2">
                  {s.itemCount}
                  {typeof s.visibleItemCount === "number" ? (
                    <div class="text-xs text-slate-600">可见 {s.visibleItemCount}</div>
                  ) : null}
                </td>
                <td class="px-3 py-2">
                  {typeof s.newItemCount === "number" ? (
                    <span
                      class:list={[
                        "text-xs font-medium",
                        s.newItemCount > 0 ? "text-emerald-800" : "text-slate-600"
                      ]}
                    >
                      {s.newItemCount > 0 ? `+${s.newItemCount}` : "0"}
                    </span>
                  ) : (
                    <span class="text-xs text-slate-600">-</span>
                  )}
                </td>
                <td
                  class:list={[
                    "px-3 py-2 text-xs",
                    (() => {
                      const h = staleHours(s.latestPublishedAt);
                      if (h != null && h >= staleThresholdHours) return "text-amber-800";
                      return "text-slate-600";
                    })()
                  ]}
                >
                  {fmt(s.latestPublishedAt)}
                </td>
                <td class="px-3 py-2 text-xs text-slate-600">
                  {typeof s.consecutiveFails === "number" && s.consecutiveFails > 0
                    ? `${s.consecutiveFails}次`
                    : "-"}
                </td>
                <td class="px-3 py-2 text-xs text-slate-600">
                  {s.rawItemCount != null && s.filteredItemCount != null
                    ? `${s.rawItemCount} → ${s.filteredItemCount}`
                    : "-"}
                </td>
                <td class="px-3 py-2">{s.httpStatus ?? "-"}</td>
                <td class="px-3 py-2">{s.durationMs}ms</td>
                <td class="px-3 py-2 text-xs text-slate-600">
                  {typeof s.attempts === "number" && s.attempts > 1
                    ? `${s.attempts}次 · ${s.waitMs ?? 0}ms`
                    : "-"}
                </td>
                <td class="px-3 py-2">
                  <span class="rounded-full border border-slate-900/10 bg-white/50 px-3 py-1 text-xs text-slate-700">
                    {s.used}
                  </span>
                </td>
                <td class="px-3 py-2 text-xs text-slate-600" title={s.error ?? ""}>
                  {s.ok ? "-" : (s.error?.slice(0, 80) ?? "未知错误")}
                </td>
                <td class="px-3 py-2 text-xs text-slate-600">{suggest(s)}</td>
              </tr>
            ))
          }
        </tbody>
      </table>
    </div>
  </div>
</SiteLayout>
