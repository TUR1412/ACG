---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { readGeneratedStatus } from "../../lib/generated-data";
import { formatDateTime } from "../../lib/format";
import { t } from "../../i18n/i18n";

const status = await readGeneratedStatus();
const updatedAt = status.generatedAt ? formatDateTime("ja", status.generatedAt) : "-";

const totalSources = status.sources.length;
const okSources = status.sources.filter((s) => s.ok).length;
const errSources = totalSources - okSources;
const totalItems = status.sources.reduce((sum, s) => sum + (s.itemCount ?? 0), 0);
const slowest = [...status.sources].sort((a, b) => b.durationMs - a.durationMs)[0];
const successRate = totalSources > 0 ? Math.round((okSources / totalSources) * 100) : 0;

const generatedAtMs = status.generatedAt ? Date.parse(status.generatedAt) : NaN;
function staleHours(latestPublishedAt?: string): number | null {
  if (!latestPublishedAt) return null;
  if (!Number.isFinite(generatedAtMs)) return null;
  const latestMs = Date.parse(latestPublishedAt);
  if (!Number.isFinite(latestMs)) return null;
  const diffMs = Math.max(0, generatedAtMs - latestMs);
  return diffMs / (1000 * 60 * 60);
}

function fmt(latestPublishedAt?: string): string {
  if (!latestPublishedAt) return "-";
  try {
    return formatDateTime("ja", latestPublishedAt);
  } catch {
    return latestPublishedAt;
  }
}

function suggest(s: (typeof status.sources)[number]): string {
  const stale = staleHours(s.latestPublishedAt);
  if (s.ok) {
    if (stale != null && stale >= 72) return "更新停止の可能性：最新の公開日時が古いです。";
    return "-";
  }
  if (typeof s.consecutiveFails === "number" && s.consecutiveFails >= 3) {
    return `連続失敗 ${s.consecutiveFails} 回：URL/パーサ/ブロック状況を確認してください。`;
  }
  if (s.httpStatus === 429) return "リクエスト過多：更新頻度を下げる／キャッシュ利用／時間をおいて再試行。";
  if (s.httpStatus === 403 || s.httpStatus === 401) return "ブロックの可能性：RSS/公開ソース利用、取得回数を減らす。";
  if (s.httpStatus === 404) return "URL が変更された可能性：ソース URL とアダプターを更新してください。";
  const err = (s.error ?? "").toLowerCase();
  if (err.includes("timeout") || err.includes("aborted")) return "タイムアウト：時間をおく／並列数を下げる。";
  return "エラー詳細を確認し、sources 設定で調整してください。";
}
---

<SiteLayout lang="ja" title={t("ja", "status.title")} currentPath="/status/">
  <div class="glass rounded-2xl p-5">
    <h1 class="m-0 text-2xl font-semibold leading-tight tracking-tight text-slate-950 md:text-3xl">
      {t("ja", "status.title")}
    </h1>
    <p class="mt-2 text-sm text-slate-700">
      {t("ja", "status.lastRun")}: {updatedAt} · {status.durationMs}ms
    </p>
  </div>

  <section class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <div class="glass shine rounded-2xl p-5">
      <div class="text-xs font-semibold text-slate-600">成功率</div>
      <div class="mt-2 text-2xl font-semibold text-slate-950">{successRate}%</div>
      <div class="mt-1 text-xs text-slate-600">
        OK {okSources} / {totalSources}
      </div>
    </div>

    <div class="glass shine rounded-2xl p-5">
      <div class="text-xs font-semibold text-slate-600">エラー（ソース）</div>
      <div class="mt-2 text-2xl font-semibold text-rose-800">{errSources}</div>
      <div class="mt-1 text-xs text-slate-600">単一ソースの失敗は全体に影響しません</div>
    </div>

    <div class="glass shine rounded-2xl p-5">
      <div class="text-xs font-semibold text-slate-600">取得件数</div>
      <div class="mt-2 text-2xl font-semibold text-slate-950">{totalItems}</div>
      <div class="mt-1 text-xs text-slate-600">キャッシュ/フォールバック含む</div>
    </div>

    <div class="glass shine rounded-2xl p-5">
      <div class="text-xs font-semibold text-slate-600">最遅ソース</div>
      <div class="mt-2 text-base font-semibold text-slate-950 line-clamp-3">{slowest?.name ?? "-"}</div>
      <div class="mt-1 text-xs text-slate-600">{slowest ? `${slowest.durationMs}ms · ${slowest.used}` : "-"}</div>
    </div>
  </section>

  <div class="mt-6 glass rounded-2xl p-5">
    <h2 class="m-0 text-sm font-semibold text-slate-950">{t("ja", "status.sources")}</h2>
    <div class="mt-3 overflow-x-auto">
      <table class="w-full border-separate border-spacing-y-2 text-sm">
        <thead class="text-left text-xs text-slate-600">
          <tr>
            <th class="px-3">ソース</th>
            <th class="px-3">状態</th>
            <th class="px-3">件数</th>
            <th class="px-3">新規</th>
            <th class="px-3">最新</th>
            <th class="px-3">連続</th>
            <th class="px-3">解析</th>
            <th class="px-3">HTTP</th>
            <th class="px-3">時間</th>
            <th class="px-3">リトライ</th>
            <th class="px-3">方式</th>
            <th class="px-3">エラー</th>
            <th class="px-3">ヒント</th>
          </tr>
        </thead>
        <tbody>
          {status.sources.map((s) => (
            <tr class="glass">
              <td class="px-3 py-2">
                <a class="font-medium text-slate-950 hover:underline" href={s.url} target="_blank" rel="noreferrer noopener">
                  {s.name}
                </a>
                <div class="text-xs text-slate-600">{s.id}</div>
              </td>
              <td class="px-3 py-2">
                <span
                  class:list={[
                    "rounded-full px-3 py-1 text-xs font-medium",
                    s.ok ? "bg-emerald-500/15 text-emerald-800" : "bg-rose-500/15 text-rose-800"
                  ]}
                >
                  {s.ok ? t("ja", "status.ok") : t("ja", "status.error")}       
                </span>
              </td>
              <td class="px-3 py-2">
                {s.itemCount}
                {typeof s.visibleItemCount === "number" ? (
                  <div class="text-xs text-slate-600">表示 {s.visibleItemCount}</div>
                ) : null}
              </td>
              <td class="px-3 py-2">
                {typeof s.newItemCount === "number" ? (
                  <span
                    class:list={[
                      "text-xs font-medium",
                      s.newItemCount > 0 ? "text-emerald-800" : "text-slate-600"
                    ]}
                  >
                    {s.newItemCount > 0 ? `+${s.newItemCount}` : "0"}
                  </span>
                ) : (
                  <span class="text-xs text-slate-600">-</span>
                )}
              </td>
              <td
                class:list={[
                  "px-3 py-2 text-xs",
                  (() => {
                    const h = staleHours(s.latestPublishedAt);
                    if (h != null && h >= 72) return "text-amber-800";
                    return "text-slate-600";
                  })()
                ]}
              >
                {fmt(s.latestPublishedAt)}
              </td>
              <td class="px-3 py-2 text-xs text-slate-600">
                {typeof s.consecutiveFails === "number" && s.consecutiveFails > 0
                  ? `${s.consecutiveFails}回`
                  : "-"}
              </td>
              <td class="px-3 py-2 text-xs text-slate-600">
                {s.rawItemCount != null && s.filteredItemCount != null ? `${s.rawItemCount} → ${s.filteredItemCount}` : "-"}
              </td>
              <td class="px-3 py-2">{s.httpStatus ?? "-"}</td>
              <td class="px-3 py-2">{s.durationMs}ms</td>
              <td class="px-3 py-2 text-xs text-slate-600">
                {typeof s.attempts === "number" && s.attempts > 1 ? `${s.attempts}回 · ${s.waitMs ?? 0}ms` : "-"}
              </td>
              <td class="px-3 py-2">
                <span class="rounded-full border border-slate-900/10 bg-white/50 px-3 py-1 text-xs text-slate-700">
                  {s.used}
                </span>
              </td>
              <td class="px-3 py-2 text-xs text-slate-600" title={s.error ?? ""}>
                {s.ok ? "-" : s.error?.slice(0, 80) ?? "不明なエラー"}
              </td>
              <td class="px-3 py-2 text-xs text-slate-600">{suggest(s)}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>
</SiteLayout>
