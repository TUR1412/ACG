---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { readGeneratedStatus } from "../../lib/generated-data";
import { formatDateTime } from "../../lib/format";
import { t } from "../../i18n/i18n";

const status = await readGeneratedStatus();
const updatedAt = status.generatedAt ? formatDateTime("ja", status.generatedAt) : "-";
---

<SiteLayout lang="ja" title={t("ja", "status.title")} currentPath="/status/">
  <div class="glass rounded-2xl p-5">
    <h1 class="m-0 text-2xl font-semibold text-slate-950">{t("ja", "status.title")}</h1>
    <p class="mt-2 text-sm text-slate-700">
      {t("ja", "status.lastRun")}: {updatedAt} · {status.durationMs}ms
    </p>
  </div>

  <div class="mt-4 glass rounded-2xl p-5">
    <h2 class="m-0 text-sm font-semibold text-slate-950">{t("ja", "status.sources")}</h2>
    <div class="mt-3 overflow-x-auto">
      <table class="w-full border-separate border-spacing-y-2 text-sm">
        <thead class="text-left text-xs text-slate-600">
          <tr>
            <th class="px-3">ソース</th>
            <th class="px-3">状態</th>
            <th class="px-3">件数</th>
            <th class="px-3">HTTP</th>
            <th class="px-3">時間</th>
            <th class="px-3">方式</th>
            <th class="px-3">エラー</th>
          </tr>
        </thead>
        <tbody>
          {status.sources.map((s) => (
            <tr class="glass">
              <td class="px-3 py-2">
                <a class="font-medium text-slate-950 hover:underline" href={s.url} target="_blank" rel="noreferrer">
                  {s.name}
                </a>
                <div class="text-xs text-slate-600">{s.id}</div>
              </td>
              <td class="px-3 py-2">
                <span
                  class:list={[
                    "rounded-full px-3 py-1 text-xs font-medium",
                    s.ok ? "bg-emerald-500/15 text-emerald-800" : "bg-rose-500/15 text-rose-800"
                  ]}
                >
                  {s.ok ? t("ja", "status.ok") : t("ja", "status.error")}
                </span>
              </td>
              <td class="px-3 py-2">{s.itemCount}</td>
              <td class="px-3 py-2">{s.httpStatus ?? "-"}</td>
              <td class="px-3 py-2">{s.durationMs}ms</td>
              <td class="px-3 py-2">
                <span class="rounded-full border border-slate-900/10 bg-white/50 px-3 py-1 text-xs text-slate-700">
                  {s.used}
                </span>
              </td>
              <td class="px-3 py-2 text-xs text-slate-600" title={s.error ?? ""}>
                {s.ok ? "-" : s.error?.slice(0, 80) ?? "不明なエラー"}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>
</SiteLayout>
