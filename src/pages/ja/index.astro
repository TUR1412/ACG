---
import SiteLayout from "../../layouts/SiteLayout.astro";
import PostList from "../../components/PostList.astro";
import PreferencesPanel from "../../components/PreferencesPanel.astro";
import SpotlightGrid from "../../components/SpotlightGrid.astro";
import { t } from "../../i18n/i18n";
import { readGeneratedPosts, readGeneratedStatus } from "../../lib/generated-data";
import { CATEGORIES, categoryLabel, type Category } from "../../lib/categories";
import { CATEGORY_THEME } from "../../lib/category-theme";
import { formatDateTime } from "../../lib/format";
import { href } from "../../lib/href";

const posts = await readGeneratedPosts();
const status = await readGeneratedStatus();

const latest = posts.slice(0, 60);
const updatedAt = status.generatedAt ? formatDateTime("ja", status.generatedAt) : "-";

const cutoff24h = Date.now() - 24 * 60 * 60 * 1000;
const recent24h = posts.filter((p) => new Date(p.publishedAt).getTime() >= cutoff24h);

const tagCount = new Map<string, number>();
for (const p of recent24h) {
  for (const tag of p.tags ?? []) tagCount.set(tag, (tagCount.get(tag) ?? 0) + 1);
}
const hotTags = [...tagCount.entries()]
  .sort((a, b) => b[1] - a[1])
  .slice(0, 12)
  .map(([tag, count]) => ({ tag, count }));

const categoryCount = new Map<Category, number>();
for (const c of CATEGORIES) categoryCount.set(c, 0);
for (const p of recent24h) categoryCount.set(p.category, (categoryCount.get(p.category) ?? 0) + 1);

const brief = recent24h.slice(0, 10);
const randomPick = posts.length > 0 ? posts[Math.floor(Math.random() * Math.min(200, posts.length))] : null;

const spotlight = (() => {
  const withCover = recent24h.filter((p) => Boolean(p.cover));
  const used = new Set(withCover.map((p) => p.id));
  const rest = recent24h.filter((p) => !used.has(p.id));
  return [...withCover, ...rest].slice(0, 6);
})();
---

<SiteLayout lang="ja" currentPath="/">
  <section class="grid gap-4 md:grid-cols-12">
    <div class="glass relative overflow-hidden rounded-2xl p-6 md:col-span-8">
      <div class="pointer-events-none absolute inset-0">
        <div class="absolute -left-24 -top-24 h-72 w-72 rounded-full bg-violet-500/10 blur-3xl"></div>
        <div class="absolute -right-24 -bottom-24 h-72 w-72 rounded-full bg-sky-500/10 blur-3xl"></div>
      </div>

      <div class="relative flex flex-wrap items-end justify-between gap-4">
        <div>
          <h1 class="m-0 text-2xl font-semibold text-slate-950">{t("ja", "nav.latest")}</h1>
          <p class="mt-1 text-xs text-slate-600">
            {t("ja", "common.updatedAt")} {updatedAt} · {posts.length} 件
          </p>
        </div>

        <div class="flex flex-wrap items-center gap-2 text-xs text-slate-700">
          <span class="glass rounded-full px-3 py-1">
            {t("ja", "search.result")} <span id="acg-search-count">-</span>
          </span>
          <span class="glass rounded-full px-3 py-1">
            {t("ja", "home.unread")} <span id="acg-unread-count">-</span>
          </span>
        </div>
      </div>

      <div class="relative mt-4">
        <label class="sr-only" for="acg-search">{t("ja", "search.placeholder")}</label>
        <div class="relative">
          <div class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path
                d="M10.5 19a8.5 8.5 0 1 1 0-17 8.5 8.5 0 0 1 0 17Z"
                stroke="currentColor"
                stroke-width="2"
              />
              <path
                d="M21 21l-4.3-4.3"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
          </div>
          <input
            id="acg-search"
            class="w-full rounded-xl border border-slate-900/10 bg-white/60 px-4 py-3 pl-10 text-sm text-slate-950 outline-none focus:border-slate-900/20 focus:bg-white/70"
            placeholder={t("ja", "search.placeholder")}
          />
        </div>
      </div>

      <div class="relative mt-5 grid grid-cols-2 gap-3 sm:grid-cols-4">
        {CATEGORIES.map((c) => (
          <a
            href={href(`/ja/c/${c}/`)}
            class="glass clickable group relative overflow-hidden rounded-2xl p-4"
          >
            <div class:list={["absolute inset-0 bg-gradient-to-br opacity-60", CATEGORY_THEME[c].cover]}></div>
            <div class="relative flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="text-sm font-semibold text-slate-950">{categoryLabel("ja", c)}</div>
                <div class="mt-1 text-xs text-slate-600">24時間 {categoryCount.get(c) ?? 0} 件</div>
              </div>
              <div
                class:list={[
                  "grid size-11 place-items-center rounded-2xl border border-slate-900/10 bg-white/55",
                  CATEGORY_THEME[c].ink
                ]}
              >
                {c === "anime" ? (
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path
                      d="M7 7.8c0-1.55 1.26-2.8 2.8-2.8h4.4c1.55 0 2.8 1.25 2.8 2.8v8.4c0 1.55-1.25 2.8-2.8 2.8H9.8A2.8 2.8 0 0 1 7 16.2V7.8Z"
                      stroke="currentColor"
                      stroke-width="2"
                    />
                    <path d="M10 9h4M10 13h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                ) : c === "game" ? (
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path
                      d="M7.5 14.5h-1a2 2 0 0 1-2-2v-1.2a6.3 6.3 0 0 1 12.6 0v1.2a2 2 0 0 1-2 2h-1"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                    />
                    <path d="M9 12h2M10 11v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <path d="M14.8 11.8h.01M16.4 13.2h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
                  </svg>
                ) : c === "goods" ? (
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path
                      d="M6 10.5V8.8A2.8 2.8 0 0 1 8.8 6h6.4A2.8 2.8 0 0 1 18 8.8v1.7"
                      stroke="currentColor"
                      stroke-width="2"
                    />
                    <path
                      d="M5.5 10.5h13v9.2A2.3 2.3 0 0 1 16.2 22H7.8A2.3 2.3 0 0 1 5.5 19.7v-9.2Z"
                      stroke="currentColor"
                      stroke-width="2"
                    />
                    <path d="M9 13.2h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                ) : (
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path
                      d="M12 22a8.5 8.5 0 1 0-8.5-8.5"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                    />
                    <path
                      d="M7.5 11.5c.7-1.8 2.4-3 4.5-3s3.8 1.2 4.5 3"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                    />
                    <path d="M9.2 15.4h.01M14.8 15.4h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
                  </svg>
                )}
              </div>
            </div>
          </a>
        ))}
      </div>
    </div>

    <aside class="glass rounded-2xl p-6 md:col-span-4">
      <h2 class="m-0 text-sm font-semibold text-slate-950">{t("ja", "home.hotTags")}</h2>
      {hotTags.length === 0 ? (
        <p class="mt-2 text-sm text-slate-700">{t("ja", "common.noData")}</p>
      ) : (
        <div class="mt-3 flex flex-wrap gap-2">
          {hotTags.map(({ tag, count }) => (
            <button
              type="button"
              class="rounded-full border border-slate-900/10 bg-white/55 px-3 py-1 text-xs text-slate-700 hover:bg-white/75 clickable"
              data-tag={tag}
              title={`${tag} · ${count}`}
            >
              {tag}
            </button>
          ))}
        </div>
      )}
    </aside>
  </section>

  <SpotlightGrid posts={spotlight} lang="ja" title={t("ja", "home.spotlight")} />

  <section class="mt-4 grid gap-4 md:grid-cols-12">
    <div class="md:col-span-8">
      <PostList posts={latest} lang="ja" />
    </div>

    <div class="grid gap-4 md:col-span-4">
      <PreferencesPanel lang="ja" />

      <div class="glass rounded-2xl p-6">
        <div class="flex items-center justify-between gap-3">
          <h2 class="m-0 text-sm font-semibold text-slate-950">{t("ja", "home.dailyBrief")}</h2>
          <button
            type="button"
            id="acg-brief-copy"
            class="rounded-xl bg-slate-950 px-3 py-2 text-xs font-medium text-white clickable"
          >
            {t("ja", "home.copyBrief")}
          </button>
        </div>

        {brief.length === 0 ? (
          <p class="mt-3 text-sm text-slate-700">{t("ja", "common.noData")}</p>
        ) : (
          <div class="mt-3">
            <p id="acg-brief-message" class="mt-2 hidden text-xs text-slate-600"></p>
            <ol id="acg-daily-brief" class="mt-3 space-y-2 pl-4 text-sm text-slate-700">
              {brief.map((p) => (
                <li class="leading-snug">
                  <a class="hover:underline" href={href(`/ja/p/${p.id}/`)}>
                    {p.title}
                  </a>
                </li>
              ))}
            </ol>
          </div>
        )}
      </div>

      <div class="glass rounded-2xl p-6">
        <h2 class="m-0 text-sm font-semibold text-slate-950">{t("ja", "home.randomPick")}</h2>
        {randomPick ? (
          <div class="mt-3">
            <a href={href(`/ja/p/${randomPick.id}/`)} class="group relative block overflow-hidden rounded-2xl">
              <div class="absolute inset-0 bg-gradient-to-br from-violet-500/20 via-sky-500/15 to-emerald-500/15"></div>
              {randomPick.cover ? (
                <img
                  src={randomPick.cover}
                  alt=""
                  loading="lazy"
                  decoding="async"
                  referrerpolicy="no-referrer"
                  class="h-40 w-full object-cover transition-transform duration-500 ease-out group-hover:scale-[1.03]"
                  onerror="this.style.opacity='0'; this.style.pointerEvents='none'"
                />
              ) : (
                <div class="grid h-40 place-items-center">
                  <div class="glass rounded-2xl px-3 py-2 text-xs font-semibold text-slate-950/80">ACG</div>
                </div>
              )}
              <div class="absolute inset-0 bg-gradient-to-t from-slate-950/55 via-slate-950/10 to-transparent"></div>
              <div class="absolute bottom-3 left-3 right-3 text-sm font-semibold leading-snug text-white line-clamp-3">
                {randomPick.title}
              </div>
            </a>

            <a
              class="mt-3 inline-flex rounded-xl bg-slate-950 px-4 py-2 text-xs font-medium text-white clickable"
              href={href(`/ja/p/${randomPick.id}/`)}
            >
              見てみる
            </a>
          </div>
        ) : (
          <p class="mt-2 text-sm text-slate-700">{t("ja", "common.noData")}</p>
        )}
      </div>
    </div>
  </section>
</SiteLayout>
