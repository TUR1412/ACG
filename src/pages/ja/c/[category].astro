---
import SiteLayout from "../../../layouts/SiteLayout.astro";
import PostList from "../../../components/PostList.astro";
import PreferencesDrawer from "../../../components/PreferencesDrawer.astro";
import Icon from "../../../components/Icon.astro";
import { readGeneratedPosts, readGeneratedStatus } from "../../../lib/generated-data";
import { CATEGORIES, categoryLabel, type Category } from "../../../lib/categories";
import { getCategoryTheme } from "../../../lib/category-theme";
import { t } from "../../../i18n/i18n";
import { applyDerivedMetrics, buildSourceHealthMap } from "../../../lib/metrics";

export function getStaticPaths() {
  return CATEGORIES.map((category) => ({ params: { category } }));
}

const posts = await readGeneratedPosts();
const status = await readGeneratedStatus();
const healthMap = buildSourceHealthMap(status.sources ?? []);
const enriched = applyDerivedMetrics(posts, healthMap);
const category = Astro.params.category as Category;
const inCategory = enriched.filter((p) => p.category === category);
const total = inCategory.length;
const filtered = inCategory.slice(0, 60);
const theme = getCategoryTheme(category);
---

<SiteLayout
  lang="ja"
  title={categoryLabel("ja", category)}
  currentCategory={category}
  currentPath={`/c/${category}/`}
>
  <section class="acg-layout-grid grid gap-grid md:grid-cols-12">
    <div class="glass relative overflow-hidden rounded-2xl p-6 md:col-span-8">
      <div class="pointer-events-none absolute inset-0">
        <div class:list={["absolute -left-24 -top-24 h-72 w-72 rounded-full blur-3xl", theme.glow]}></div>
        <div class="absolute -right-24 -bottom-24 h-72 w-72 rounded-full bg-slate-900/5 blur-3xl"></div>
      </div>

      <div class="relative flex flex-wrap items-end justify-between gap-4">
        <div>
          <h1 class="m-0 text-phi-xl font-semibold leading-tight tracking-tight text-slate-950 md:text-phi-2xl">
            {categoryLabel("ja", category)}
          </h1>
          <p class="mt-1 text-xs text-slate-600">{t("ja", "nav.latest")} · {filtered.length}/{total} 件</p>
        </div>

        <div class="flex flex-wrap items-center gap-2 text-xs text-slate-700">
          <span class="glass rounded-full px-3 py-1">
            {t("ja", "search.result")} <span id="acg-search-count">-</span>
          </span>
          <span class="glass rounded-full px-3 py-1">
            {t("ja", "home.unread")} <span id="acg-unread-count">-</span>
          </span>
        </div>
      </div>

      <div class="relative mt-4">
        <label class="sr-only" for="acg-search">{t("ja", "search.placeholder")}</label>
        <div class="relative">
          <div class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">
            <Icon name="search" size={18} />
          </div>
          <input
            id="acg-search"
            type="search"
            enterkeyhint="search"
            class="w-full rounded-xl border border-slate-900/10 bg-white/60 px-4 py-3 pl-10 text-sm text-slate-950 outline-none focus:border-slate-900/20 focus:bg-white/70"
            placeholder={t("ja", "search.placeholder")}
          />
          <button
            type="button"
            id="acg-search-clear"
            class="absolute right-2 top-1/2 size-9 -translate-y-1/2 items-center justify-center rounded-xl border border-slate-900/10 bg-white/65 text-slate-700 hover:bg-white/80 clickable"
            hidden
            aria-label={t("ja", "search.clear")}
            title={t("ja", "search.clear")}
          >
            <Icon name="x" size={18} />
          </button>
        </div>
      </div>

      <div class="acg-hscroll relative mt-3 -mx-1 flex gap-2 overflow-x-auto px-1 pb-1 sm:mx-0 sm:flex-wrap sm:overflow-visible sm:px-0">
        <button
          type="button"
          class="acg-chip rounded-full px-3 py-1 text-xs font-semibold clickable"
          data-quick-toggle="only-followed"
          data-active="false"
        >
          {t("ja", "prefs.followOnly")}
        </button>
        <button
          type="button"
          class="acg-chip rounded-full px-3 py-1 text-xs font-semibold clickable"
          data-quick-toggle="only-followed-sources"
          data-active="false"
        >
          {t("ja", "prefs.followedSourcesOnly")}
        </button>
        <button
          type="button"
          class="acg-chip rounded-full px-3 py-1 text-xs font-semibold clickable"
          data-quick-toggle="hide-read"
          data-active="false"
        >
          {t("ja", "prefs.hideRead")}
        </button>
        <button
          type="button"
          class="acg-chip rounded-full px-3 py-1 text-xs font-semibold clickable"
          data-quick-toggle="only-stable"
          data-active="false"
        >
          {t("ja", "prefs.onlyStableSources")}
        </button>
        <button
          type="button"
          class="acg-chip rounded-full px-3 py-1 text-xs font-semibold clickable"
          data-quick-toggle="dedup"
          data-active="false"
        >
          {t("ja", "prefs.dedupView")}
        </button>
        <button
          type="button"
          class="acg-chip rounded-full px-3 py-1 text-xs font-semibold clickable"
          data-quick-lens="2h"
          data-active="false"
        >
          {t("ja", "prefs.timeLens2h")}
        </button>
        <button
          type="button"
          class="acg-chip rounded-full px-3 py-1 text-xs font-semibold clickable"
          data-quick-lens="6h"
          data-active="false"
        >
          {t("ja", "prefs.timeLens6h")}
        </button>
        <button
          type="button"
          class="acg-chip rounded-full px-3 py-1 text-xs font-semibold clickable"
          data-quick-lens="24h"
          data-active="false"
        >
          {t("ja", "prefs.timeLens24h")}
        </button>
        <button
          type="button"
          class="acg-chip rounded-full px-3 py-1 text-xs font-semibold clickable"
          data-quick-sort="pulse"
          data-active="false"
        >
          {t("ja", "prefs.sortPulse")}
        </button>
        <button
          type="button"
          class="acg-chip inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-semibold clickable"
          data-search-preset={`cat:${category}`}
          title={`cat:${category}`}
          aria-label={t("ja", "search.scopeAllCategory")}
        >
          <Icon name="search" size={16} />
          <span>{t("ja", "search.scopeAllCategory")}</span>
        </button>
        <button
          type="button"
          class="acg-chip inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-semibold clickable"
          data-open-prefs
          data-active="false"
        >
          <Icon name="sliders" size={16} />
          <span>{t("ja", "prefs.title")}</span>
        </button>
      </div>
    </div>

    <div class="md:col-span-4">
      <PreferencesDrawer lang="ja" />
    </div>
  </section>

  <section class="mt-6">
    <PostList posts={filtered} lang="ja" />
    <div id="acg-list-empty" class="mt-4 glass shine rounded-2xl p-8 hidden">
      <div class="flex flex-col items-center gap-3 text-center">
        <div class="radar grid size-16 place-items-center shadow-e4">
          <span class="text-sm font-bold text-white/90">?</span>
        </div>
        <div>
          <div class="text-sm font-semibold text-slate-950">{t("ja", "search.emptyTitle")}</div>
          <div class="mt-2 text-xs leading-relaxed text-slate-600">{t("ja", "search.emptyHint")}</div>
        </div>
        <button
          type="button"
          id="acg-clear-search"
          class="rounded-xl bg-slate-950 px-4 py-2 text-xs font-medium text-white clickable"
        >
          {t("ja", "search.clear")}
        </button>
      </div>
    </div>
  </section>
</SiteLayout>
