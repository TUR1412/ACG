---
// 首页信号板：汇总热榜、时间透镜与来源健康度的快速入口。
import type { Post } from "../../lib/types";
import type { Lang } from "../../i18n/i18n";
import { t } from "../../i18n/i18n";
import { formatRelativeHours } from "../../lib/format";
import { href } from "../../lib/href";
import type { SourceHealthSummary } from "../../lib/metrics";
import Chip from "../atoms/Chip.astro";

type HotTag = { tag: string; count: number };
type LensCounts = Record<"2h" | "6h" | "24h", number>;

type Props = {
  lang: Lang;
  pulseTop: Post[];
  hotTags: HotTag[];
  lensCounts: LensCounts;
  healthSummary: SourceHealthSummary;
  totalPosts: number;
};

const { lang, pulseTop, hotTags, lensCounts, healthSummary, totalPosts } = Astro.props;
const noData = t(lang, "common.noData");
const stableRatio =
  healthSummary.total > 0 ? Math.round((healthSummary.stable / healthSummary.total) * 100) : 0;
---

<section class="acg-signal-board glass rounded-2xl p-5">
  <div class="acg-signal-grid">
    <div class="acg-signal-card acg-signal-pulse">
      <div class="acg-signal-head">
        <h2 class="m-0 text-sm font-semibold text-slate-950">{t(lang, "home.pulseTop")}</h2>
        <Chip class="text-[11px]" icon="chart" iconSize={14} data-quick-sort="pulse" data-active="false">
          <span>{t(lang, "prefs.sortPulse")}</span>
        </Chip>
      </div>
      {
        pulseTop.length === 0 ? (
          <p class="mt-3 text-sm text-slate-600">{noData}</p>
        ) : (
          <ol class="acg-signal-list mt-3">
            {pulseTop.map((post, idx) => {
              const title = lang === "zh" ? (post.titleZh ?? post.title) : (post.titleJa ?? post.title);
              const score = typeof post.pulseScore === "number" ? post.pulseScore : 0;
              const when = formatRelativeHours(lang, post.publishedAt) ?? "";
              return (
                <li>
                  <a class="acg-signal-item" href={href(`/${lang}/p/${post.id}/`)}>
                    <span class="acg-signal-rank">{String(idx + 1).padStart(2, "0")}</span>
                    <span class="acg-signal-title">{title}</span>
                    <span class="acg-signal-meta">
                      <span class="acg-signal-score">{score}</span>
                      <span class="acg-signal-time">{when}</span>
                    </span>
                  </a>
                </li>
              );
            })}
          </ol>
        )
      }
    </div>

    <div class="acg-signal-card acg-signal-lens">
      <div class="acg-signal-head">
        <h3 class="m-0 text-sm font-semibold text-slate-950">{t(lang, "home.timeLens")}</h3>
      </div>
      <div class="mt-3 grid gap-2">
        <button type="button" class="acg-signal-chip clickable" data-quick-lens="2h" data-active="false">
          <span>{t(lang, "prefs.timeLens2h")}</span>
          <span class="acg-signal-chip-count">{lensCounts["2h"]}</span>
        </button>
        <button type="button" class="acg-signal-chip clickable" data-quick-lens="6h" data-active="false">
          <span>{t(lang, "prefs.timeLens6h")}</span>
          <span class="acg-signal-chip-count">{lensCounts["6h"]}</span>
        </button>
        <button type="button" class="acg-signal-chip clickable" data-quick-lens="24h" data-active="false">
          <span>{t(lang, "prefs.timeLens24h")}</span>
          <span class="acg-signal-chip-count">{lensCounts["24h"]}</span>
        </button>
        <button type="button" class="acg-signal-chip clickable" data-quick-lens="all" data-active="false">
          <span>{t(lang, "prefs.timeLensAll")}</span>
          <span class="acg-signal-chip-count">{totalPosts}</span>
        </button>
      </div>
    </div>

    <div class="acg-signal-card acg-signal-health">
      <div class="acg-signal-head">
        <h3 class="m-0 text-sm font-semibold text-slate-950">{t(lang, "home.sourceTrust")}</h3>
        <Chip class="text-[11px]" data-quick-toggle="only-stable" data-active="false">
          {t(lang, "home.stableSources")}
        </Chip>
      </div>
      <div class="mt-3">
        <div class="acg-signal-health-bar">
          <span style={`--acg-health:${stableRatio};`}></span>
        </div>
        <p class="mt-2 text-xs text-slate-600">
          {t(lang, "home.stableSources")}
          {healthSummary.stable}/{healthSummary.total} · {stableRatio}%
        </p>
      </div>
      <div class="mt-3 flex flex-wrap gap-2 text-[11px]">
        <span class="acg-health-pill acg-health-excellent">
          <span class="acg-health-dot" aria-hidden="true"></span>
          <span class="acg-health-text">{healthSummary.excellent}</span>
        </span>
        <span class="acg-health-pill acg-health-good">
          <span class="acg-health-dot" aria-hidden="true"></span>
          <span class="acg-health-text">{healthSummary.good}</span>
        </span>
        <span class="acg-health-pill acg-health-warn">
          <span class="acg-health-dot" aria-hidden="true"></span>
          <span class="acg-health-text">{healthSummary.warn}</span>
        </span>
        <span class="acg-health-pill acg-health-down">
          <span class="acg-health-dot" aria-hidden="true"></span>
          <span class="acg-health-text">{healthSummary.down}</span>
        </span>
      </div>
    </div>

    <div class="acg-signal-card acg-signal-tags">
      <div class="acg-signal-head">
        <h3 class="m-0 text-sm font-semibold text-slate-950">{t(lang, "home.hotTags")}</h3>
      </div>
      {
        hotTags.length === 0 ? (
          <p class="mt-2 text-sm text-slate-600">{noData}</p>
        ) : (
          <div class="acg-hscroll mt-3 -mx-1 flex gap-2 overflow-x-auto px-1 pb-1 sm:mx-0 sm:flex-wrap sm:overflow-visible sm:px-0">
            {hotTags.map(({ tag, count }) => (
              <button
                type="button"
                class="inline-flex max-w-[26ch] shrink-0 items-center gap-2 rounded-full border border-slate-900/10 bg-white/55 px-3 py-1 text-xs text-slate-700 hover:bg-white/75 clickable"
                data-tag={tag}
                title={`${tag} · ${count}`}
              >
                <span class="max-w-[20ch] truncate">{tag}</span>
                <span class="rounded-full bg-slate-900/5 px-2 py-0.5 text-[10px] font-semibold text-slate-700">
                  {count}
                </span>
              </button>
            ))}
          </div>
        )
      }
    </div>
  </div>
</section>
