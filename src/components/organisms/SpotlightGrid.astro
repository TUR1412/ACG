---
import type { Post } from "../../lib/types";
import { t, type Lang } from "../../i18n/i18n";
import { categoryLabel } from "../../lib/categories";
import { getCategoryTheme } from "../../lib/category-theme";
import { formatDateTime, formatRelativeHours } from "../../lib/format";
import { href } from "../../lib/href";
import { resolveCover } from "../../lib/cover";
import CategoryIcon from "../atoms/CategoryIcon.astro";
import Icon from "../atoms/Icon.astro";
import SourceBadge from "../molecules/SourceBadge.astro";

type Props = {
  posts: Post[];
  lang: Lang;
  title: string;
};

const { posts, lang, title } = Astro.props;

const items = posts.slice(0, 6);
const metaLabel = lang === "ja" ? "カバーカルーセル" : "封面轮播";
const hintMobile = lang === "ja" ? "左右にスワイプ" : "左右滑动";
const hintDesktop = lang === "ja" ? "ドラッグ / スクロール" : "拖拽 / 滚轮";
const helpText =
  lang === "ja"
    ? "左右キーで切り替え、Enter で開きます。"
    : "使用左右方向键切换封面，按 Enter 打开详情。";
const prevLabel = lang === "ja" ? "前へ" : "上一张";
const nextLabel = lang === "ja" ? "次へ" : "下一张";
const emptyText = lang === "ja" ? "データがありません" : "暂无数据";
const helpId = "acg-spotlight-help";
const retryCoverLabel = lang === "ja" ? "画像を再試行" : "重试封面";
const freshLabel = lang === "ja" ? "新着" : "NEW";
const bookmarkLabel = t(lang, "nav.bookmarks");
const healthLabels = {
  excellent: t(lang, "health.excellent"),
  good: t(lang, "health.good"),
  warn: t(lang, "health.warn"),
  down: t(lang, "health.down")
} as const;

function postHref(post: Post): string {
  return href(`/${lang}/p/${post.id}/`);
}

function postTitle(post: Post): string {
  return lang === "zh" ? post.titleZh ?? post.title : post.titleJa ?? post.title;
}

function whenLabel(post: Post): string {
  return formatRelativeHours(lang, post.publishedAt) ?? formatDateTime(lang, post.publishedAt);
}
---

<section class="mt-6 acg-spotlight">
  <div class="flex flex-wrap items-end justify-between gap-3">
    <h2 class="m-0 inline-flex items-center rounded-full border border-slate-900/10 bg-white/80 px-3 py-1 text-sm font-semibold text-slate-950">
      {title}
    </h2>
    <div class="flex flex-wrap items-center justify-end gap-2 text-xs">
      <span class="inline-flex items-center gap-2 rounded-full border border-slate-900/10 bg-white/80 px-3 py-1 text-xs font-semibold text-slate-950">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false" class="acg-icon">
          <path
            d="M6.8 7.2h10.4A3.8 3.8 0 0 1 21 11v2A3.8 3.8 0 0 1 17.2 16.8H6.8A3.8 3.8 0 0 1 3 13v-2a3.8 3.8 0 0 1 3.8-3.8Z"
            stroke="currentColor"
            stroke-width="2"
          />
          <path d="M8.6 10.3 6.8 12l1.8 1.7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M15.4 10.3 17.2 12l-1.8 1.7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <span>{metaLabel}</span>
      </span>

      <span class="hidden sm:inline-flex items-center gap-1 rounded-full border border-slate-900/10 bg-white/45 px-2.5 py-1 text-[11px] font-medium text-slate-950">
        <Icon name="info" size={14} />
        <span>{hintDesktop}</span>
      </span>
      <span class="sm:hidden inline-flex items-center rounded-full border border-slate-900/10 bg-white/80 px-2.5 py-1 text-[11px] font-medium text-slate-950">  
        {hintMobile}
      </span>
    </div>
  </div>

  {items.length === 0 ? (
    <div class="mt-3 glass rounded-2xl p-6">
      <p class="m-0 text-sm text-slate-700">{emptyText}</p>
    </div>
  ) : (
    <div
      class="mt-3 acg-carousel glass-card rounded-2xl"
      data-spotlight-carousel
      tabindex="0"
      aria-roledescription="carousel"
      aria-describedby={helpId}
    >
      <p id={helpId} class="sr-only">{helpText}</p>

      <div class="acg-carousel-track" data-carousel-track>
        {items.map((post, i) => {
          const theme = getCategoryTheme(post.category);
          const cover = resolveCover(post.cover, 1200);
          const coverOriginal = post.coverOriginal ?? cover?.original;
          const showCover = Boolean(cover && !/^https?:\/\//i.test(cover.src));
          const publishedAtMs = new Date(post.publishedAt).getTime();
          const isFresh =
            Number.isFinite(publishedAtMs) &&
            Date.now() - publishedAtMs >= 0 &&
            Date.now() - publishedAtMs < 6 * 60 * 60 * 1000;
          const pulseScore = typeof post.pulseScore === "number" ? post.pulseScore : null;
          const health = post.sourceHealth ?? null;
          return (
            <article
              class="acg-carousel-slide"
              data-carousel-slide
              data-index={i}
              data-post-id={post.id}
              data-category={post.category}
              data-source-id={post.sourceId}
              data-has-cover={showCover ? "true" : "false"}
            >
              <a href={postHref(post)} class="acg-carousel-hit" aria-label={postTitle(post)}></a>

              <div class:list={["acg-carousel-bg bg-gradient-to-br", theme.cover]}></div>
              <div class="acg-cover-fallback" aria-hidden="true">
                <div class="acg-cover-fallback-inner">
                  <div class="acg-cover-fallback-icon">
                    <CategoryIcon category={post.category} size={22} />
                  </div>
                  <div class="acg-cover-fallback-brand">ACG Radar</div>
                  <div class="acg-cover-fallback-meta">{categoryLabel(lang, post.category)}</div>
                </div>
              </div>
              {showCover ? (
                <img
                  src={cover!.src}
                  alt=""
                  loading={i === 0 ? "eager" : "lazy"}
                  decoding="async"
                  fetchpriority={i === 0 ? "high" : undefined}
                  referrerpolicy="no-referrer"
                  data-acg-cover
                  data-acg-cover-original-src={coverOriginal ?? ""}
                  class="acg-carousel-img"
                  onload="window.__acgCoverLoad?.(this)"
                  onerror="this.closest('[data-carousel-slide]')?.classList.add('cover-failed'); this.style.opacity='0'; this.style.pointerEvents='none'; window.__acgCoverError?.(this)"
                />
              ) : null}
              <div class="acg-carousel-vignette"></div>

              <div class="acg-carousel-content">
                <div class="flex flex-wrap items-center gap-2">
                  {isFresh ? (
                    <span class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-3 py-1 text-[11px] font-semibold text-white/90 backdrop-blur-md">
                      <span class="acg-dot-pulse size-1.5 rounded-full bg-emerald-400"></span>
                      <span>{freshLabel}</span>
                    </span>
                  ) : null}
                  {pulseScore != null ? (
                    <span class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-3 py-1 text-[11px] font-semibold text-white/90 backdrop-blur-md">
                      <Icon name="chart" size={14} />
                      <span>{pulseScore}</span>
                    </span>
                  ) : null}
                  <span class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-3 py-1 text-xs font-semibold text-white">
                    <span class:list={["size-1.5 rounded-full", theme.dot]}></span>
                    <span>{categoryLabel(lang, post.category)}</span>
                  </span>
                  <span class="inline-flex rounded-full border border-white/15 bg-white/10 px-3 py-1 text-[11px] font-medium text-white/90">
                    {whenLabel(post)}
                  </span>
                </div>

                <div class="mt-3 text-white">
                  <div class="text-xl font-semibold leading-tight tracking-tight md:text-2xl line-clamp-3">
                    {postTitle(post)}
                  </div>
                  <div class="mt-2">
                    <SourceBadge
                      name={post.sourceName}
                      tone="dark"
                      dotClass={theme.dot}
                      compact
                      health={health ?? undefined}
                      healthLabel={health ? healthLabels[health] : undefined}
                    />
                  </div>
                </div>
              </div>

              <button
                type="button"
                class="acg-carousel-bookmark acg-icon-fab clickable"
                data-bookmark-id={post.id}
                aria-pressed="false"
                aria-label={bookmarkLabel}
                title={bookmarkLabel}
              >
                <span data-bookmark-icon aria-hidden="true">
                  <Icon name="star" size={18} />
                </span>
              </button>

              <button
                type="button"
                class="acg-cover-retry acg-icon-fab clickable"
                data-cover-retry
                aria-label={retryCoverLabel}
                title={retryCoverLabel}
              >
                <Icon name="refresh" size={18} />
              </button>
            </article>
          );
        })}
      </div>

      <button
        type="button"
        class="acg-carousel-nav acg-carousel-nav-prev clickable"
        data-carousel-prev
        aria-label={prevLabel}
        title={prevLabel}
      >
        <Icon name="arrow-left" size={18} />
      </button>

      <button
        type="button"
        class="acg-carousel-nav acg-carousel-nav-next clickable"
        data-carousel-next
        aria-label={nextLabel}
        title={nextLabel}
      >
        <Icon name="arrow-right" size={18} />
      </button>

      <div class="acg-carousel-controls" aria-label="Spotlight controls">
        <div class="acg-carousel-controls-inner">
          <div class="acg-carousel-dots" role="tablist" aria-label="Spotlight slides">
            {items.map((post, i) => (
              <button
                type="button"
                class="acg-carousel-dot"
                data-carousel-dot
                data-index={i}
                aria-label={`${i + 1}: ${postTitle(post)}`}
              ></button>
            ))}
          </div>
        </div>
      </div>
    </div>
  )}
</section>
