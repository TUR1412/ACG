---
import type { Post } from "../lib/types";
import type { Lang } from "../i18n/i18n";
import { categoryLabel } from "../lib/categories";
import { getCategoryTheme } from "../lib/category-theme";
import { formatDateTime, formatRelativeHours } from "../lib/format";
import { href } from "../lib/href";

type Props = {
  posts: Post[];
  lang: Lang;
  title: string;
};

const { posts, lang, title } = Astro.props;

const items = posts.slice(0, 6);
const metaLabel = lang === "ja" ? "Bento · カバー優先" : "Bento · 封面优先";
const emptyText = lang === "ja" ? "データがありません" : "暂无数据";

const spans = [
  "md:col-span-7 md:row-span-2",
  "md:col-span-5",
  "md:col-span-5",
  "md:col-span-4",
  "md:col-span-4",
  "md:col-span-4"
];

function postHref(post: Post): string {
  return href(`/${lang}/p/${post.id}/`);
}

function whenLabel(post: Post): string {
  return formatRelativeHours(lang, post.publishedAt) ?? formatDateTime(lang, post.publishedAt);
}
---

<section class="mt-4">
  <div class="flex flex-wrap items-end justify-between gap-3">
    <h2 class="m-0 text-sm font-semibold text-slate-950">{title}</h2>
    <div class="text-xs text-slate-600">{metaLabel}</div>
  </div>

  {items.length === 0 ? (
    <div class="mt-3 glass rounded-2xl p-6">
      <p class="m-0 text-sm text-slate-700">{emptyText}</p>
    </div>
  ) : (
    <div class="mt-3 grid gap-4 md:grid-cols-12 md:auto-rows-[180px]">
      {items.map((post, i) => {
        const theme = getCategoryTheme(post.category);
        const large = i === 0;
        return (
          <article
            class:list={[
              "glass clickable shine group relative overflow-hidden rounded-2xl",
              "aspect-[16/9] md:aspect-auto md:h-full",
              spans[i] ?? "md:col-span-4"
            ]}
            data-post-id={post.id}
            data-category={post.category}
            data-source-id={post.sourceId}
          >
            <a href={postHref(post)} class="absolute inset-0 z-0" aria-label={post.title}></a>

            <div class:list={["absolute inset-0 z-0 bg-gradient-to-br", theme.cover]}></div>
            {post.cover ? (
              <img
                src={post.cover}
                alt=""
                loading="lazy"
                decoding="async"
                referrerpolicy="no-referrer"
                class="absolute inset-0 z-0 h-full w-full object-cover transition-transform duration-500 ease-out group-hover:scale-[1.03]"
                onerror="this.style.opacity='0'; this.style.pointerEvents='none'"
              />
            ) : null}
            <div class="absolute inset-0 z-0 bg-gradient-to-t from-slate-950/70 via-slate-950/10 to-transparent"></div>

            <div class="absolute left-4 top-4 z-10 flex flex-wrap items-center gap-2">
              <span class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-3 py-1 text-xs font-semibold text-white backdrop-blur-md">
                <span class:list={["size-1.5 rounded-full", theme.dot]}></span>
                <span>{categoryLabel(lang, post.category)}</span>
              </span>
              <span class="inline-flex rounded-full border border-white/15 bg-white/10 px-3 py-1 text-[11px] font-medium text-white/90 backdrop-blur-md">
                {whenLabel(post)}
              </span>
            </div>

            <button
              type="button"
              class="glass clickable absolute right-4 top-4 z-20 rounded-xl px-3 py-2 text-xs font-medium text-slate-950"
              data-bookmark-id={post.id}
              aria-pressed="false"
              title="Bookmark"
            >
              <span data-bookmark-label>☆</span>
            </button>

            <div class="absolute bottom-4 left-4 right-4 z-10">
              <div class:list={["text-white", large ? "text-lg font-semibold sm:text-xl" : "text-sm font-semibold"]}>
                <div class:list={["leading-snug", large ? "line-clamp-3" : "line-clamp-3"]}>{post.title}</div>
              </div>
              <div class="mt-2 text-xs text-white/80">{post.sourceName}</div>
            </div>
          </article>
        );
      })}
    </div>
  )}
</section>
