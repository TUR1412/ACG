---
import type { Post } from "../lib/types";
import type { Lang } from "../i18n/i18n";
import { categoryLabel } from "../lib/categories";
import { getCategoryTheme } from "../lib/category-theme";
import { formatDateTime, formatRelativeHours } from "../lib/format";
import { href } from "../lib/href";
import { resolveCover } from "../lib/cover";
import CategoryIcon from "./CategoryIcon.astro";
import SourceBadge from "./SourceBadge.astro";

type Props = {
  posts: Post[];
  lang: Lang;
  title: string;
};

const { posts, lang, title } = Astro.props;

const items = posts.slice(0, 6);
const metaLabel = lang === "ja" ? "Cover Carousel · ←/→" : "封面轮播 · ←/→";
const helpText =
  lang === "ja"
    ? "左右キーで切り替え、Enter で開きます。"
    : "使用左右方向键切换封面，按 Enter 打开详情。";
const prevLabel = lang === "ja" ? "前へ" : "上一张";
const nextLabel = lang === "ja" ? "次へ" : "下一张";
const emptyText = lang === "ja" ? "データがありません" : "暂无数据";
const helpId = "acg-spotlight-help";
const retryCoverLabel = lang === "ja" ? "画像を再試行" : "重试封面";
const freshLabel = lang === "ja" ? "新着" : "NEW";

function postHref(post: Post): string {
  return href(`/${lang}/p/${post.id}/`);
}

function whenLabel(post: Post): string {
  return formatRelativeHours(lang, post.publishedAt) ?? formatDateTime(lang, post.publishedAt);
}
---

<section class="mt-6">
  <div class="flex flex-wrap items-end justify-between gap-3">
    <h2 class="m-0 text-sm font-semibold text-slate-950">{title}</h2>
    <div class="text-xs text-slate-600">{metaLabel}</div>
  </div>

  {items.length === 0 ? (
    <div class="mt-3 glass rounded-2xl p-6">
      <p class="m-0 text-sm text-slate-700">{emptyText}</p>
    </div>
  ) : (
    <div
      class="mt-3 acg-carousel glass-card rounded-2xl"
      data-spotlight-carousel
      tabindex="0"
      aria-roledescription="carousel"
      aria-describedby={helpId}
    >
      <p id={helpId} class="sr-only">{helpText}</p>

      <div class="acg-carousel-track" data-carousel-track>
        {items.map((post, i) => {
          const theme = getCategoryTheme(post.category);
          const cover = resolveCover(post.cover, 1200);
          const publishedAtMs = new Date(post.publishedAt).getTime();
          const isFresh =
            Number.isFinite(publishedAtMs) &&
            Date.now() - publishedAtMs >= 0 &&
            Date.now() - publishedAtMs < 6 * 60 * 60 * 1000;
          return (
            <article
              class="acg-carousel-slide"
              data-carousel-slide
              data-index={i}
              data-post-id={post.id}
              data-category={post.category}
              data-source-id={post.sourceId}
              data-has-cover={post.cover ? "true" : "false"}
            >
              <a href={postHref(post)} class="acg-carousel-hit" aria-label={post.title}></a>

              <div class:list={["acg-carousel-bg bg-gradient-to-br", theme.cover]}></div>
              <div class="acg-cover-fallback" aria-hidden="true">
                <div class="acg-cover-fallback-inner">
                  <div class="acg-cover-fallback-icon">
                    <CategoryIcon category={post.category} size={22} />
                  </div>
                  <div class="acg-cover-fallback-brand">ACG Radar</div>
                  <div class="acg-cover-fallback-meta">{categoryLabel(lang, post.category)}</div>
                </div>
              </div>
              {cover ? (
                <img
                  src={cover.src}
                  alt=""
                  loading={i === 0 ? "eager" : "lazy"}
                  decoding="async"
                  fetchpriority={i === 0 ? "high" : undefined}
                  referrerpolicy="no-referrer"
                  data-acg-cover
                  data-acg-cover-original-src={cover.original}
                  class="acg-carousel-img"
                  onload="window.__acgCoverLoad?.(this)"
                  onerror="this.closest('[data-carousel-slide]')?.classList.add('cover-failed'); this.style.opacity='0'; this.style.pointerEvents='none'; window.__acgCoverError?.(this)"
                />
              ) : null}
              <div class="acg-carousel-vignette"></div>

              <div class="acg-carousel-content">
                <div class="flex flex-wrap items-center gap-2">
                  {isFresh ? (
                    <span class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-3 py-1 text-[11px] font-semibold text-white/90 backdrop-blur-md">
                      <span class="acg-dot-pulse size-1.5 rounded-full bg-emerald-400"></span>
                      <span>{freshLabel}</span>
                    </span>
                  ) : null}
                  <span class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-3 py-1 text-xs font-semibold text-white">
                    <span class:list={["size-1.5 rounded-full", theme.dot]}></span>
                    <span>{categoryLabel(lang, post.category)}</span>
                  </span>
                  <span class="inline-flex rounded-full border border-white/15 bg-white/10 px-3 py-1 text-[11px] font-medium text-white/90">
                    {whenLabel(post)}
                  </span>
                </div>

                <div class="mt-3 text-white">
                  <div class="text-xl font-semibold leading-tight tracking-tight md:text-2xl line-clamp-3">
                    {post.title}
                  </div>
                  <div class="mt-2">
                    <SourceBadge name={post.sourceName} tone="dark" dotClass={theme.dot} compact />
                  </div>
                </div>
              </div>

              <button
                type="button"
                class="acg-carousel-bookmark glass-card clickable"
                data-bookmark-id={post.id}
                aria-pressed="false"
                title="Bookmark"
              >
                <span data-bookmark-label>☆</span>
              </button>

              <button
                type="button"
                class="acg-cover-retry glass-card clickable"
                data-cover-retry
                aria-label={retryCoverLabel}
                title={retryCoverLabel}
              >
                <span aria-hidden="true">↻</span>
              </button>
            </article>
          );
        })}
      </div>

      <div class="acg-carousel-controls" aria-hidden="true">
        <button type="button" class="acg-carousel-btn glass-card clickable" data-carousel-prev aria-label={prevLabel}>
          <span aria-hidden="true">←</span>
        </button>
        <button type="button" class="acg-carousel-btn glass-card clickable" data-carousel-next aria-label={nextLabel}>
          <span aria-hidden="true">→</span>
        </button>
      </div>

      <div class="acg-carousel-dots" role="tablist" aria-label="Spotlight slides">
        {items.map((post, i) => (
          <button
            type="button"
            class="acg-carousel-dot"
            data-carousel-dot
            data-index={i}
            aria-label={`${i + 1}: ${post.title}`}
          ></button>
        ))}
      </div>
    </div>
  )}
</section>
