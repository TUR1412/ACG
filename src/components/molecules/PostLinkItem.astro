---
import type { Post } from "../../lib/types";
import type { Lang } from "../../i18n/i18n";
import { t } from "../../i18n/i18n";
import { categoryLabel } from "../../lib/categories";
import { getCategoryTheme } from "../../lib/category-theme";
import { href } from "../../lib/href";
import { formatDateTime, formatRelativeHours } from "../../lib/format";
import Icon from "../atoms/Icon.astro";

type Props = {
  post: Post;
  lang: Lang;
  index?: number;
};

const { post, lang, index } = Astro.props;
const detailHref = href(`/${lang}/p/${post.id}/`);
const when = formatRelativeHours(lang, post.publishedAt) ?? formatDateTime(lang, post.publishedAt);
const title = lang === "zh" ? (post.titleZh ?? post.title) : (post.titleJa ?? post.title);
const theme = getCategoryTheme(post.category);
const bookmarkLabel = t(lang, "nav.bookmarks");
const pulseScore = typeof post.pulseScore === "number" ? post.pulseScore : null;
---

<article
  class="glass-card clickable group relative rounded-2xl"
  data-post-id={post.id}
  data-category={post.category}
  data-source-id={post.sourceId}
  data-published-at={post.publishedAt}
  data-pulse={pulseScore ?? ""}
  data-dedup={post.dedupKey ?? ""}
  data-source-health={post.sourceHealth ?? ""}
  data-order={typeof index === "number" ? index : ""}
>
  <a href={detailHref} aria-label={title} title={title} class="block p-4 pr-14">
    <div class="flex min-w-0 items-start gap-3">
      <span
        class="inline-flex shrink-0 items-center gap-2 rounded-full border border-slate-900/10 bg-white/55 px-2.5 py-1 text-[11px] font-semibold text-slate-700"
        title={categoryLabel(lang, post.category)}
      >
        <span class:list={["size-1.5 rounded-full", theme.dot]}></span>
        <span class="max-w-[16ch] truncate">{categoryLabel(lang, post.category)}</span>
      </span>

      <div class="min-w-0 flex-1">
        <div class="text-sm font-semibold leading-snug text-slate-950 group-hover:underline line-clamp-2">
          {title}
        </div>
        <div class="mt-1 flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-slate-600">
          <span class="whitespace-nowrap">{when}</span>
          <span class="text-slate-400">Â·</span>
          <span
            class="min-w-0 truncate"
            data-source-badge
            data-source-name={post.sourceName}
            title={post.sourceName}
          >
            {post.sourceName}
          </span>
        </div>
      </div>
    </div>
  </a>

  <button
    type="button"
    class="glass-card clickable absolute right-3 top-3 rounded-xl p-2 text-slate-950"
    data-bookmark-id={post.id}
    aria-pressed="false"
    aria-label={bookmarkLabel}
    title={bookmarkLabel}
  >
    <span data-bookmark-icon aria-hidden="true">
      <Icon name="star" size={18} />
    </span>
  </button>
</article>
