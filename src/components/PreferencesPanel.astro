---
import type { Lang } from "../i18n/i18n";
import { t } from "../i18n/i18n";
import { SOURCES } from "../../scripts/sources/index";
import { CATEGORIES, categoryLabel, isCategory, type Category } from "../lib/categories";
import Icon from "./Icon.astro";
import Segmented from "./atoms/Segmented.astro";
import SegmentedItem from "./atoms/SegmentedItem.astro";

type Props = {
  lang: Lang;
  closable?: boolean;
};

const { lang, closable = false } = Astro.props;
const closeLabel = lang === "ja" ? "閉じる" : "关闭";

const grouped = CATEGORIES.map((category) => {
  const sources = SOURCES.filter((s) => isCategory(s.category) && (s.category as Category) === category);
  return { category, sources };
}).filter((g) => g.sources.length > 0);
---

<section class="glass rounded-2xl p-5">
  <div class="flex items-center justify-between gap-2">
    <h2 class="m-0 text-sm font-semibold text-slate-950">{t(lang, "prefs.title")}</h2>
    <div class="flex items-center gap-2">
      <span class="rounded-full border border-slate-900/10 bg-white/50 px-2 py-1 text-[11px] text-slate-700">Local</span>
      {closable ? (
        <button
          type="button"
          class="md:hidden inline-flex size-8 items-center justify-center rounded-xl border border-slate-900/10 bg-white/55 text-slate-700 hover:bg-white/75 clickable"
          data-close-prefs
          aria-label={closeLabel}
          title={closeLabel}
        >
          <Icon name="x" size={18} />
        </button>
      ) : null}
    </div>
  </div>

    <div class="mt-3">
      <div class="flex flex-wrap items-center justify-between gap-3">       
        <div class="text-xs font-semibold text-slate-950">{t(lang, "prefs.theme")}</div>
        <Segmented label={t(lang, "prefs.theme")}>
          <SegmentedItem data-theme-mode="auto">
            {t(lang, "prefs.themeAuto")}
          </SegmentedItem>
          <SegmentedItem data-theme-mode="light">
            {t(lang, "prefs.themeLight")}
          </SegmentedItem>
          <SegmentedItem data-theme-mode="dark">
            {t(lang, "prefs.themeDark")}
          </SegmentedItem>
        </Segmented>
      </div>
      <p class="mt-1 text-[11px] leading-relaxed text-slate-600">{t(lang, "prefs.themeHint")}</p>
    </div>

    <div class="mt-3">
      <div class="flex flex-wrap items-center justify-between gap-3">       
        <div class="text-xs font-semibold text-slate-950">{t(lang, "prefs.view")}</div>
      </div>
      <Segmented class="mt-2" label={t(lang, "prefs.view")}>
        <SegmentedItem data-view-mode="grid">
          {t(lang, "prefs.viewGrid")}
        </SegmentedItem>
        <SegmentedItem data-view-mode="list">
          {t(lang, "prefs.viewList")}
        </SegmentedItem>
      </Segmented>
      <p class="mt-1 text-[11px] leading-relaxed text-slate-600">{t(lang, "prefs.viewHint")}</p>
    </div>

    <div class="mt-3">
      <div class="flex flex-wrap items-center justify-between gap-3">       
        <div class="text-xs font-semibold text-slate-950">{t(lang, "prefs.density")}</div>
      </div>
      <Segmented class="mt-2" label={t(lang, "prefs.density")}>
        <SegmentedItem data-density-mode="comfort">
          {t(lang, "prefs.densityComfort")}
        </SegmentedItem>
        <SegmentedItem data-density-mode="compact">
          {t(lang, "prefs.densityCompact")}
        </SegmentedItem>
      </Segmented>
      <p class="mt-1 text-[11px] leading-relaxed text-slate-600">{t(lang, "prefs.densityHint")}</p>
    </div>

  <div class="mt-3 grid gap-3">
    <label class="flex select-none items-center gap-2 text-sm text-slate-800">
      <input id="acg-only-followed" type="checkbox" class="size-4 accent-violet-600" />
      <span>{t(lang, "prefs.followOnly")}</span>
    </label>
    <label class="flex select-none items-center gap-2 text-sm text-slate-800">
      <input id="acg-only-followed-sources" type="checkbox" class="size-4 accent-violet-600" />
      <span>{t(lang, "prefs.followedSourcesOnly")}</span>
    </label>
    <label class="flex select-none items-center gap-2 text-sm text-slate-800">
      <input id="acg-hide-read" type="checkbox" class="size-4 accent-violet-600" />
      <span>{t(lang, "prefs.hideRead")}</span>
    </label>
    <label class="flex select-none items-center gap-2 text-sm text-slate-800">
      <input id="acg-only-stable-sources" type="checkbox" class="size-4 accent-violet-600" />
      <span>{t(lang, "prefs.onlyStableSources")}</span>
    </label>
    <label class="flex select-none items-center gap-2 text-sm text-slate-800">
      <input id="acg-dedup-view" type="checkbox" class="size-4 accent-violet-600" />
      <span>{t(lang, "prefs.dedupView")}</span>
    </label>
  </div>

    <div class="mt-4">
      <div class="flex flex-wrap items-center justify-between gap-3">       
        <div class="text-xs font-semibold text-slate-950">{t(lang, "prefs.timeLens")}</div>
      </div>
      <Segmented class="mt-2" label={t(lang, "prefs.timeLens")}>
        <SegmentedItem data-time-lens="all">
          {t(lang, "prefs.timeLensAll")}
        </SegmentedItem>
        <SegmentedItem data-time-lens="2h">
          {t(lang, "prefs.timeLens2h")}
        </SegmentedItem>
        <SegmentedItem data-time-lens="6h">
          {t(lang, "prefs.timeLens6h")}
        </SegmentedItem>
        <SegmentedItem data-time-lens="24h">
          {t(lang, "prefs.timeLens24h")}
        </SegmentedItem>
      </Segmented>
    </div>

    <div class="mt-3">
      <div class="flex flex-wrap items-center justify-between gap-3">       
        <div class="text-xs font-semibold text-slate-950">{t(lang, "prefs.sort")}</div>
      </div>
      <Segmented class="mt-2" label={t(lang, "prefs.sort")}>
        <SegmentedItem data-sort-mode="latest">
          {t(lang, "prefs.sortLatest")}
        </SegmentedItem>
        <SegmentedItem data-sort-mode="pulse">
          {t(lang, "prefs.sortPulse")}
        </SegmentedItem>
      </Segmented>
    </div>

  <div class="mt-4">
    <div class="flex gap-2">
      <input
        id="acg-follow-input"
        class="w-full rounded-xl border border-slate-900/10 bg-white/60 px-3 py-2 text-xs text-slate-950 outline-none focus:border-slate-900/20 focus:bg-white/70"
        placeholder={t(lang, "prefs.followPlaceholder")}
      />
      <button
        type="button"
        id="acg-follow-add"
        class="glass rounded-xl px-3 py-2 text-xs font-medium text-slate-950 clickable"
      >
        {t(lang, "prefs.followAdd")}
      </button>
    </div>
    <div id="acg-follow-list" class="mt-2 flex flex-wrap gap-2"></div>
  </div>

  <div class="mt-4">
    <div class="flex gap-2">
      <input
        id="acg-block-input"
        class="w-full rounded-xl border border-slate-900/10 bg-white/60 px-3 py-2 text-xs text-slate-950 outline-none focus:border-slate-900/20 focus:bg-white/70"
        placeholder={t(lang, "prefs.blockPlaceholder")}
      />
      <button
        type="button"
        id="acg-block-add"
        class="rounded-xl border border-rose-600/20 bg-rose-500/10 px-3 py-2 text-xs font-medium text-rose-800 clickable"
      >
        {t(lang, "prefs.blockAdd")}
      </button>
    </div>
    <div id="acg-block-list" class="mt-2 flex flex-wrap gap-2"></div>
  </div>

  <details class="mt-4 rounded-2xl border border-slate-900/10 bg-white/45 p-3">
    <summary class="cursor-pointer select-none text-xs font-semibold text-slate-950">
      {t(lang, "prefs.sources")}
      <span class="ml-2 text-[11px] font-normal text-slate-600">
        <span class="inline-flex items-center gap-1">
          ({SOURCES.length}) ·
          <span class="inline-flex items-center gap-1">
            <Icon name="star" size={14} filled />
            <span id="acg-sources-followed-count">0</span>
          </span>
        </span>
      </span>
    </summary>

    <div class="mt-3 rounded-2xl border border-slate-900/10 bg-white/50 p-3">
      <div class="flex items-center justify-between gap-3">
        <div class="text-xs font-semibold text-slate-950">{t(lang, "prefs.followedSources")}</div>
        <div class="text-[11px] text-slate-600">{t(lang, "prefs.sourcesFollowHint")}</div>
      </div>
      <div id="acg-followed-sources-list" class="mt-2 flex flex-wrap gap-2"></div>
      <p id="acg-followed-sources-empty" class="mt-2 hidden text-xs text-slate-600"></p>
    </div>

    <div class="mt-3 grid gap-4">
      {grouped.map(({ category, sources }) => (
        <div>
          <div class="text-xs font-semibold text-slate-950">{categoryLabel(lang, category)}</div>
          <div class="mt-2 grid gap-2">
            {sources.map((s) => (
              <div class="flex items-center justify-between gap-2 rounded-xl border border-slate-900/10 bg-white/50 px-3 py-2">
                <label class="flex min-w-0 select-none items-center gap-2 text-xs text-slate-800">
                  <input type="checkbox" class="size-4 accent-violet-600" data-source-toggle-id={s.id} />
                  <span class="truncate" title={s.name}>
                    {s.name}
                  </span>
                </label>
                <button
                  type="button"
                  class="glass-card rounded-xl px-3 py-2 text-xs font-medium text-slate-950 clickable"
                  data-source-follow-id={s.id}
                  data-source-follow-name={s.name}
                  aria-pressed="false"
                  aria-label={t(lang, "prefs.followSource")}
                  title={t(lang, "prefs.followSource")}
                >
                  <span data-source-follow-icon aria-hidden="true">
                    <Icon name="star" size={18} />
                  </span>
                </button>
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>
    <div class="mt-3 flex flex-wrap gap-2">
      <button
        type="button"
        id="acg-sources-enable-all"
        class="glass rounded-xl px-3 py-2 text-xs font-medium text-slate-950 clickable"
      >
        {t(lang, "prefs.enableAllSources")}
      </button>
      <button
        type="button"
        id="acg-sources-follow-all"
        class="glass rounded-xl px-3 py-2 text-xs font-medium text-slate-950 clickable"
      >
        {t(lang, "prefs.followAllSources")}
      </button>
      <button
        type="button"
        id="acg-sources-unfollow-all"
        class="glass rounded-xl px-3 py-2 text-xs font-medium text-slate-950 clickable"
      >
        {t(lang, "prefs.unfollowAllSources")}
      </button>
      <button
        type="button"
        id="acg-sources-disable-all"
        class="rounded-xl border border-rose-600/20 bg-rose-500/10 px-3 py-2 text-xs font-medium text-rose-800 clickable"
      >
        {t(lang, "prefs.disableAllSources")}
      </button>
    </div>
  </details>

  <details class="mt-4 rounded-2xl border border-slate-900/10 bg-white/45 p-3">
    <summary class="cursor-pointer select-none text-xs font-semibold text-slate-950">
      {t(lang, "prefs.telemetry")}
    </summary>

    <div class="mt-3 grid gap-3">
      <label class="flex select-none items-center gap-2 text-sm text-slate-800">
        <input id="acg-telemetry-upload" type="checkbox" class="size-4 accent-violet-600" />
        <span>{t(lang, "prefs.telemetryUpload")}</span>
      </label>

      <div class="grid gap-2">
        <div class="text-xs font-semibold text-slate-950">{t(lang, "prefs.telemetryEndpoint")}</div>
        <input
          id="acg-telemetry-endpoint"
          type="url"
          inputmode="url"
          class="w-full rounded-xl border border-slate-900/10 bg-white/60 px-3 py-2 text-xs text-slate-950 outline-none focus:border-slate-900/20 focus:bg-white/70"
          placeholder="https://example.com/telemetry"
        />
      </div>

      <p class="text-[11px] leading-relaxed text-slate-600">{t(lang, "prefs.telemetryHint")}</p>

      <div class="mt-2 flex flex-wrap items-center justify-between gap-2">
        <div class="flex flex-wrap items-center gap-2">
          <button
            type="button"
            id="acg-telemetry-export"
            class="glass rounded-xl px-3 py-2 text-xs font-medium text-slate-950 clickable"
          >
            {t(lang, "prefs.telemetryExport")}
          </button>
          <button
            type="button"
            id="acg-telemetry-clear"
            class="rounded-xl border border-rose-600/20 bg-rose-500/10 px-3 py-2 text-xs font-medium text-rose-800 clickable"
          >
            {t(lang, "prefs.telemetryClear")}
          </button>
        </div>

        <div class="flex items-center gap-3 text-[11px] text-slate-600">
          <span>
            {t(lang, "prefs.telemetryCount")} <span id="acg-telemetry-count">-</span>
          </span>
          <span>
            {t(lang, "prefs.telemetrySize")} <span id="acg-telemetry-size">-</span>
          </span>
        </div>
      </div>
    </div>
  </details>

  <p class="mt-3 text-xs leading-relaxed text-slate-600">{t(lang, "prefs.hint")}</p>
  <p
    id="acg-prefs-message"
    class="mt-2 hidden text-xs text-slate-700"
    role="status"
    aria-live="polite"
    aria-atomic="true"
  ></p>
</section>
