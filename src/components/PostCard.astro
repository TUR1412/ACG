---
import type { Post } from "../lib/types";
import type { Lang } from "../i18n/i18n";
import { categoryLabel } from "../lib/categories";
import { getCategoryTheme } from "../lib/category-theme";
import { href } from "../lib/href";
import { formatDateTime, formatRelativeHours } from "../lib/format";

type Props = {
  post: Post;
  lang: Lang;
};

const { post, lang } = Astro.props;
const detailHref = href(`/${lang}/p/${post.id}/`);
const when = formatRelativeHours(lang, post.publishedAt) ?? formatDateTime(lang, post.publishedAt);

const theme = getCategoryTheme(post.category);
---

<article
  class="glass clickable group relative overflow-hidden rounded-2xl"
  data-post-id={post.id}
  data-category={post.category}
  data-source-id={post.sourceId}
>
  <a href={detailHref} class="relative block aspect-[16/9]">
    <div class:list={["absolute inset-0 bg-gradient-to-br", theme.cover]}></div>
    {post.cover ? (
      <img
        src={post.cover}
        alt=""
        loading="lazy"
        decoding="async"
        referrerpolicy="no-referrer"
        class="absolute inset-0 h-full w-full object-cover transition-transform duration-500 ease-out group-hover:scale-[1.03]"
        onerror="this.style.opacity='0'; this.style.pointerEvents='none'"
      />
    ) : (
      <div class="absolute inset-0 grid place-items-center">
        <div class="glass rounded-2xl px-3 py-2 text-xs font-semibold text-slate-950/80">ACG Radar</div>
      </div>
    )}
    <div class="absolute inset-0 bg-gradient-to-t from-slate-950/45 via-slate-950/10 to-transparent"></div>

    <div class="absolute left-3 top-3">
      <span class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-2.5 py-1 text-xs font-semibold text-white backdrop-blur-md">
        <span class:list={["size-1.5 rounded-full", theme.dot]}></span>
        <span>{categoryLabel(lang, post.category)}</span>
      </span>
    </div>
  </a>

  <div class="p-4">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <a href={detailHref} class="block text-[15px] font-semibold leading-snug text-slate-950 hover:underline">
          {post.title}
        </a>
        <div class="mt-1 flex flex-wrap items-center gap-x-2 gap-y-1 text-xs">
          <a class="text-slate-700 hover:underline" href={post.sourceUrl} target="_blank" rel="noreferrer">
            {post.sourceName}
          </a>
          <span class="text-slate-400">·</span>
          <span class="text-slate-500">{when}</span>
        </div>
      </div>

      <button
        type="button"
        class="glass rounded-xl px-3 py-2 text-xs font-medium text-slate-950 clickable"
        data-bookmark-id={post.id}
        aria-pressed="false"
        title="Bookmark"
      >
        <span data-bookmark-label>☆</span>
      </button>
    </div>

    {post.summary && <p class="mt-2 line-clamp-3 text-sm leading-relaxed text-slate-700">{post.summary}</p>}

    {post.tags?.length > 0 && (
      <div class="mt-3 flex flex-wrap gap-2">
        {post.tags.slice(0, 6).map((tag) => (
          <button
            type="button"
            class:list={[
              "rounded-full border border-slate-900/10 bg-white/50 px-2.5 py-1 text-xs hover:bg-white/70 clickable",
              theme.ink
            ]}
            data-tag={tag}
            title="Filter"
          >
            {tag}
          </button>
        ))}
      </div>
    )}
  </div>
</article>
