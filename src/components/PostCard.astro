---
import type { Post } from "../lib/types";
import type { Lang } from "../i18n/i18n";
import { categoryLabel } from "../lib/categories";
import { getCategoryTheme } from "../lib/category-theme";
import { href } from "../lib/href";
import { formatDateTime, formatRelativeHours } from "../lib/format";
import { resolveCover } from "../lib/cover";
import CategoryIcon from "./CategoryIcon.astro";
import Icon from "./Icon.astro";
import SourceBadge from "./SourceBadge.astro";

type Props = {
  post: Post;
  lang: Lang;
  animateIndex?: number;
};

const { post, lang, animateIndex } = Astro.props;
const detailHref = href(`/${lang}/p/${post.id}/`);
const when = formatRelativeHours(lang, post.publishedAt) ?? formatDateTime(lang, post.publishedAt);

const theme = getCategoryTheme(post.category);
const animateStyle = typeof animateIndex === "number" ? `--i: ${animateIndex};` : undefined;
const retryCoverLabel = lang === "ja" ? "画像を再試行" : "重试封面";
const cover = resolveCover(post.cover, 960);
const coverOriginal = post.coverOriginal ?? cover?.original;
const title = lang === "zh" ? post.titleZh ?? post.title : post.titleJa ?? post.title;
const snippet =
  lang === "zh"
    ? post.summaryZh ?? post.previewZh ?? post.summary ?? post.preview
    : post.summaryJa ?? post.previewJa ?? post.summary ?? post.preview;
const publishedAtMs = new Date(post.publishedAt).getTime();
const isFresh = Number.isFinite(publishedAtMs) && Date.now() - publishedAtMs >= 0 && Date.now() - publishedAtMs < 6 * 60 * 60 * 1000;
const freshLabel = lang === "ja" ? "新着" : "NEW";
---

<article
  class:list={[
    "glass-card acg-card clickable shine group relative overflow-hidden rounded-2xl",
    typeof animateIndex === "number" ? "stagger-item" : ""
  ]}
  style={animateStyle}
  data-post-id={post.id}
  data-category={post.category}
  data-source-id={post.sourceId}
  data-has-cover={post.cover ? "true" : "false"}
>
  <div class="flex gap-3 p-3 sm:block sm:p-0">
    <div class="relative w-32 shrink-0 sm:w-full">
      <a href={detailHref} class="relative block aspect-[4/3] overflow-hidden rounded-xl sm:aspect-[16/9] sm:rounded-none">
        <div class:list={["absolute inset-0 bg-gradient-to-br", theme.cover]}></div>
        <div class="acg-cover-fallback" aria-hidden="true">
          <div class="acg-cover-fallback-inner">
            <div class="acg-cover-fallback-icon">
              <CategoryIcon category={post.category} size={22} />
            </div>
            <div class="acg-cover-fallback-brand">ACG Radar</div>
            <div class="acg-cover-fallback-meta">{categoryLabel(lang, post.category)}</div>
          </div>
        </div>
        {cover ? (
          <img
            src={cover.src}
            alt=""
            loading="lazy"
            decoding="async"
            referrerpolicy="no-referrer"
            data-acg-cover
            data-acg-cover-original-src={coverOriginal ?? ""}
            class="absolute inset-0 h-full w-full object-cover transition-transform duration-500 ease-out group-hover:scale-[1.03]"
            onload="window.__acgCoverLoad?.(this)"
            onerror="this.closest('[data-post-id]')?.classList.add('cover-failed'); this.style.opacity='0'; this.style.pointerEvents='none'; window.__acgCoverError?.(this)"
          />
        ) : null}
        <div class="absolute inset-0 bg-gradient-to-t from-slate-950/45 via-slate-950/10 to-transparent"></div>

        <div class="absolute left-3 top-3 hidden flex-wrap items-center gap-2 sm:flex">
          <span class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-2.5 py-1 text-xs font-semibold text-white">
            <span class:list={["size-1.5 rounded-full", theme.dot]}></span>
            <span>{categoryLabel(lang, post.category)}</span>
          </span>

          {isFresh ? (
            <span class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-2.5 py-1 text-[11px] font-semibold text-white/90">
              <span class="acg-dot-pulse size-1.5 rounded-full bg-emerald-400"></span>
              <span>{freshLabel}</span>
            </span>
          ) : null}
        </div>

        <div class="absolute bottom-3 left-3 hidden sm:block">
          <span class="inline-flex max-w-[22ch] truncate rounded-full border border-white/15 bg-white/10 px-2.5 py-1 text-[11px] font-medium text-white/90">
            {when}
          </span>
        </div>
      </a>

      <button
        type="button"
        class="acg-cover-retry glass-card clickable"
        data-cover-retry
        aria-label={retryCoverLabel}
        title={retryCoverLabel}
      >
        <Icon name="refresh" size={18} />
      </button>
    </div>

    <div class="min-w-0 flex-1 py-1 sm:p-5">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <a
            href={detailHref}
            class="block text-[15px] font-semibold leading-snug text-slate-950 hover:underline line-clamp-2 sm:text-base"
          >
            {title}
          </a>

          <div class="mt-1 flex flex-wrap items-center gap-x-2 gap-y-1 text-[11px] text-slate-600 sm:text-xs">
            <span class="inline-flex items-center gap-2 font-medium text-slate-700">
              <span class:list={["size-1.5 rounded-full", theme.dot]}></span>
              <span>{categoryLabel(lang, post.category)}</span>
            </span>
            <span class="text-slate-400">·</span>
            <span>{when}</span>
            {isFresh ? (
              <span class="inline-flex items-center gap-1 rounded-full bg-emerald-500/10 px-2 py-0.5 font-semibold text-emerald-800">
                <span class="acg-dot-pulse size-1.5 rounded-full bg-emerald-500"></span>
                <span>{freshLabel}</span>
              </span>
            ) : null}
          </div>

          <div class="mt-1 flex flex-wrap items-center gap-x-2 gap-y-1 text-xs">
            <SourceBadge name={post.sourceName} url={post.sourceUrl} dotClass={theme.dot} compact />
          </div>
        </div>

        <button
          type="button"
          class="glass-card rounded-full p-2 text-xs font-medium text-slate-950 clickable sm:rounded-xl sm:px-3 sm:py-2"
          data-bookmark-id={post.id}
          aria-pressed="false"
          title="Bookmark"
        >
          <span data-bookmark-icon aria-hidden="true">
            <Icon name="star" size={18} />
          </span>
        </button>
      </div>

      {snippet && <p class="mt-2 line-clamp-2 text-sm leading-relaxed text-slate-600 sm:line-clamp-3">{snippet}</p>}

      {post.tags?.length > 0 && (
        <div class="acg-hscroll mt-3 -mx-1 flex gap-2 overflow-x-auto px-1 pb-1 sm:mx-0 sm:flex-wrap sm:overflow-visible sm:px-0">
          {post.tags.slice(0, 4).map((tag) => (
            <button
              type="button"
              class:list={[
                "shrink-0 whitespace-nowrap rounded-full border border-slate-900/10 bg-white/50 px-2.5 py-1 text-xs hover:bg-white/70 clickable",
                theme.ink
              ]}
              data-tag={tag}
              title="Filter"
            >
              {tag}
            </button>
          ))}
        </div>
      )}
    </div>
  </div>
</article>
